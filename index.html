<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>GIS 모바일</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://hamancctv.github.io/2/favicon.ico" sizes="32x32"/>
  <link rel="stylesheet" href="https://hamancctv.github.io/2/style.css">
  <style>
    #mapWrapper { position: relative; }

    /* ✅ 검색창 + 제안창 스타일 */
    .gx-suggest-search{
      position:absolute; top:8px; left:50%; transform:translateX(-50%);
      display:flex; gap:8px; align-items:center;
      width:min(520px,90vw); z-index:600;
    }
    .gx-suggest-search input{
      flex:1; height:40px; padding:0 12px; border:1px solid #ccc; border-radius:10px;
      background:#fff; font-size:14px; outline:none;
    }
    .gx-suggest-search button{ display:none; }
    .gx-suggest-box{
      position:absolute; top:48px; left:50%; transform:translateX(-50%) translateY(-6px);
      width:min(520px,90vw);
      max-height:40vh; overflow-y:auto;
      border:1px solid #ccc; border-radius:10px;
      background:rgba(255,255,255,0.96);
      box-shadow:0 8px 20px rgba(0,0,0,.15);
      z-index:610;
      opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease;
      display:block;
    }
    .gx-suggest-box.open{ opacity:1; transform:translateX(-50%) translateY(0); pointer-events:auto; }
    .gx-suggest-item{ padding:10px 12px; cursor:pointer; display:flex; align-items:center; gap:8px; }
    .gx-suggest-item:hover, .gx-suggest-item.active{ background:#eef3ff; }
    .gx-suggest-title{ display:inline-block; max-width:60%; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-weight:600; }
    .gx-badge{ font-size:12px; color:#555; background:#f2f4f8; padding:2px 6px; border-radius:6px; }
    .gx-suggest-empty{ color:#777; padding:12px; }
  </style>
</head>
<body>
  <div id="alert-overlay"><div id="alert-message"></div></div>
  <button id="btnDistance">거리</button>

  <div id="container">
    <div id="rvWrapper">
      <div id="roadview" style="width:100%;height:100%;"></div>
      <div id="close" title="로드뷰닫기" onclick="closeRoadview()"><span class="img"></span></div>
    </div>
    <div id="mapWrapper">
      <div id="map" style="width:100%;height:100%"></div>
      <div id="roadviewControl" onclick="setRoadviewRoad()"></div>

      <!-- ✅ 검색창 + 제안창 -->
      <div class="gx-suggest-search">
        <input type="search" class="gx-input" placeholder="예) ㅎㅇㄱㅂㄱㅅ, ㄷ032, 시설명…" autocomplete="off" />
        <button type="button" class="gx-btn">검색</button>
      </div>
      <div class="gx-suggest-box"></div>
    </div>
  </div>

  <div class="toolbar-right">
    <input type="text" id="gpsyx" class="input-common" inputmode="none"
           value="35.2725308711779, 128.406307024695"/>
    <button id="btn_input_copy" class="btn-common">복사</button>
  </div>

  <div class="custom_typecontrol2_m radius_border">
    <span id="toggle_group" class="btn btn-common">회선</span>
    <span id="btnCurrentMe" class="btn btn-common" onclick="toggleMyLocation()">위치</span>
    <span id="btnTrackMe" class="btn btn-common" onclick="toggleTracking()">추적</span>
  </div>

  <!-- SDK & 외부 스크립트 -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services,clusterer,drawing&autoload=false"></script>
  <script src="https://code.jquery.com/jquery-3.6.1.js"></script>

  <!-- 외부 유틸 -->
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js?v=20250929a"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js?v=20250929a"></script>
  <script src="https://hamancctv.github.io/2/markers-handler.js?v=20250930"></script>

  <!-- ✅ 검색 로직 -->
  <script>
  (function(){
    const box = document.querySelector('.gx-suggest-box');
    const kw  = document.querySelector('.gx-input');
    const CHO = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
    const CHO_SET = new Set(CHO);

    const normalize = s => (s||"").toUpperCase().replace(/\s+/g,"");
    function buildKey(str){
      let out=""; for (const ch of (str||"")){
        const c = ch.charCodeAt(0);
        if (c>=0xAC00 && c<=0xD7A3) out += CHO[Math.floor((c-0xAC00)/588)];
        else if (CHO_SET.has(ch)) out += ch;
        else if (/[0-9A-Z]/.test(ch)) out += ch.toUpperCase();
      }
      return out;
    }
    const esc = s => (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    const RAW = (window.SEL_SUGGEST||[]).map((it,idx)=>({
      id: it.id || `s_${idx}`,
      name: it.name1 || it.name || "",
      line: it.line || "",
      encloser: it.encloser || "",
      addr: it.addr || "",
      lat: parseFloat(it.lat), lng: parseFloat(it.lng),
      ip: it.ip || "",
    }));
    RAW.forEach(it=>{ it.key = buildKey([it.name,it.line,it.encloser,it.ip].filter(Boolean).join(" ")); it.nameLen=(it.name||"").length; });
    const IDMAP = Object.fromEntries(RAW.map(it=>[it.id,it]));

    function match(q){
      const k=buildKey(q); if(!k) return [];
      const res=[];
      for(const it of RAW){ if(it.key.indexOf(k)!==-1) res.push(it); if(res.length>=2000) break; }
      res.sort((a,b)=>a.nameLen-b.nameLen);
      return res.slice(0,30);
    }
    function render(items){
      if (!items.length){ box.innerHTML=`<div class="gx-suggest-empty">검색 결과 없음</div>`; return; }
      box.innerHTML=items.map(it=>`
        <div class="gx-suggest-item" data-id="${it.id}">
          <span class="gx-suggest-title">${esc(it.name)}</span>
          ${it.line?`<span class="gx-badge">${esc(it.line)}</span>`:""}
          ${it.encloser?`<span class="gx-badge">${esc(it.encloser)}</span>`:""}
          ${it.ip?`<span class="gx-badge">${esc(it.ip)}</span>`:""}
        </div>`).join('');
    }
    function openBox(){ box.classList.add('open'); }
    function closeBox(){ box.classList.remove('open'); }

    function applySelection(item){
      if (!item) return;
      kw.value=item.name;
      const markers=window.markers||[];
      const found=markers.find(m=>{
        const p=m.getPosition(); return p&&Math.abs(p.getLat()-item.lat)<1e-9&&Math.abs(p.getLng()-item.lng)<1e-9;
      });
      if(found&&window.kakao&&window.kakao.maps){
        kakao.maps.event.trigger(found,"mousedown");
        setTimeout(()=>kakao.maps.event.trigger(found,"mouseup"),0);
        map.panTo(found.getPosition());
      }else if(Number.isFinite(item.lat)&&Number.isFinite(item.lng)){
        map.panTo(new kakao.maps.LatLng(item.lat,item.lng));
      }
      closeBox();
    }

    kw.addEventListener('input',()=>{
      const v=kw.value.trim(); if(!v){closeBox();return;}
      const items=match(v); if(items.length){ render(items); openBox(); } else closeBox();
    });
    kw.addEventListener('keydown',e=>{
      const items=box.querySelectorAll('.gx-suggest-item');
      let activeIdx=[...items].findIndex(el=>el.classList.contains('active'));
      if(e.key==='ArrowDown'){ e.preventDefault(); activeIdx=(activeIdx+1)%items.length; }
      else if(e.key==='ArrowUp'){ e.preventDefault(); activeIdx=(activeIdx-1+items.length)%items.length; }
      else if(e.key==='Enter'){ e.preventDefault(); const list=match(kw.value); if(list.length){ applySelection(list[activeIdx>=0?activeIdx:0]); } return;}
      items.forEach((el,idx)=>el.classList.toggle('active',idx===activeIdx));
    });
    box.addEventListener('mousedown',e=>{
      const el=e.target.closest('.gx-suggest-item'); if(!el) return;
      applySelection(IDMAP[el.dataset.id]); e.preventDefault();
    });
    document.addEventListener('click',e=>{
      if(!e.target.closest('.gx-suggest-search')&&!e.target.closest('.gx-suggest-box')) closeBox();
    });
  })();
  </script>

  <script>
  // ===== 카카오맵 초기화 (로드뷰, 내 위치/추적, 마커 초기화 등) =====
  kakao.maps.load(function(){
    const mapCenter=new kakao.maps.LatLng(35.2725308711779,128.406307024695);
    const map=new kakao.maps.Map(document.getElementById('map'),{center:mapCenter,level:4});
    map.setMaxLevel(9); window.map=map;

    // ... ✅ 로드뷰, 내 위치, 추적, 거리재기, positions/markers-handler 초기화 로직 그대로 유지 ...
  });
  </script>
</body>
</html>
