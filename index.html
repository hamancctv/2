<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>GIS 라이트 (안정판)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

<!-- Kakao Maps SDK -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>

<!-- 기존 스타일 -->
<link rel="stylesheet" href="https://hamancctv.github.io/2/style.css" />

<style>
  html, body { height:100%; margin:0; }
  #container { position:relative; height:100%; overflow:hidden; }
  #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
  #map { width:100%; height:100%; }

  /* 로드뷰 전체화면 */
  #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
  #roadview  { width:100%; height:100%; }
  .view_roadview #rvWrapper { display:block; z-index:1; }
  .view_roadview #mapWrapper {
    position:absolute; left:8px; bottom:8px;
    width:26%; height:26%;
    min-width:200px; min-height:150px;
    border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }

  #close {
    position:absolute; top:8px; left:8px;
    padding:6px; background:#fff; border:1px solid #c8c8c8; border-radius:6px;
    cursor:pointer; z-index:3; box-shadow:0 1px #888;
  }
  #close .img {
    display:block; width:14px; height:14px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/rv_close.png) no-repeat;
  }

  /* 좌측 툴바 */
  .toolbar { position:fixed; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:10; }

  .btn-satellite {
    width:40px; height:40px;
    display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #ccc; border-radius:8px; background:#fff; color:#555;
    cursor:pointer; transition:all .2s ease; box-sizing:border-box;
  }
  .btn-satellite:hover { box-shadow:0 3px 12px rgba(0,0,0,.12); }
  .btn-satellite.selected { border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff; }
  .btn-satellite svg { width:18px; height:18px; display:block; }
  .btn-satellite svg circle { fill:currentColor; }

  #roadviewControl{
    width:40px; height:40px;
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer;
    border:1px solid #ccc; border-radius:8px; background:#fff !important;
    color:#555; transition:all .2s ease; box-sizing:border-box;
  }
  #roadviewControl:hover{ box-shadow:0 3px 12px rgba(0,0,0,.12); }
  #roadviewControl.active{
    border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff;
  }
  #roadviewControl::before{
    content:"";
    width:18px; height:18px; border-radius:50%;
    display:block;
    background: radial-gradient(#fff 0 28%, currentColor 29% 100%);
  }

  #mapWrapper .rv-resizer{
    position:absolute; right:6px; top:6px;
    width:16px; height:16px;
    border:1px solid #bbb; border-radius:4px; background:#fff;
    box-shadow:0 1px 3px rgba(0,0,0,.2);
    cursor: nesw-resize;
    z-index:650; display:none;
  }
  #mapWrapper .rv-resizer::before{
    content:""; position:absolute; inset:2px;
    background: linear-gradient(135deg, transparent 50%, #888 0) no-repeat;
    opacity:.7;
  }
  .view_roadview #mapWrapper .rv-resizer{ display:block; }
</style>
</head>
<body>
<div id="container">
  <div id="mapWrapper">
    <div id="map"></div>
    <div class="toolbar">
      <button id="btnSatellite" class="btn-satellite" title="위성뷰">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>
      </button>
      <button id="roadviewControl" title="로드뷰"></button>
    </div>
    <div class="rv-resizer" aria-hidden="true"></div>
  </div>

  <div id="rvWrapper">
    <div id="roadview"></div>
    <div id="close" title="로드뷰 닫기"><span class="img"></span></div>
  </div>
</div>

<!-- 외부 스크립트 -->
<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
<script src="https://hamancctv.github.io/2/sel_suggest.js"></script>
<script src="https://hamancctv.github.io/2/markers-handler.js"></script>
<script src="https://hamancctv.github.io/2/search-suggest.js"></script>
<script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
<script src="https://hamancctv.github.io/2/btnDistance.js"></script>

<script>
let map, geocoder, places;
let rv, rvClient;
let overlayOn = false;
let mapWalker = null;
let pickMode = false;

/* ===== 오버레이 관리 registry ===== */
const __rvOverlayRegistry = new Set();
function __rvIsWalker(o){ return mapWalker && o === mapWalker.walker; }

/* === Patch Functions (중복 방지) === */
function patchOverlayZTracking(){
  const list = [kakao.maps.CustomOverlay, kakao.maps.Marker, kakao.maps.Polyline].filter(Boolean);
  list.forEach(C=>{
    if(!C || !C.prototype || C.prototype.__rvPatched) return;
    const origSetMap = C.prototype.setMap;
    if(typeof origSetMap!=='function') return;
    C.prototype.__rvOriginalSetMap = origSetMap;
    C.prototype.setMap = function(m){
      const ret = origSetMap.apply(this, arguments);
      if(m) __rvOverlayRegistry.add(this); else __rvOverlayRegistry.delete(this);
      return ret;
    };
    C.prototype.__rvPatched = true;
  });
}

function patchZIndexSetter(){
  const list = [kakao.maps.Marker, kakao.maps.CustomOverlay, kakao.maps.Polyline].filter(Boolean);
  list.forEach(C=>{
    if(!C || !C.prototype || C.prototype.__rvPatchedSetZ) return;
    const orig = C.prototype.setZIndex;
    if(typeof orig!=='function') return;
    C.prototype.setZIndex = function(z){
      if(overlayOn && !__rvIsWalker(this)){ return orig.call(this,1); }
      return orig.apply(this, arguments);
    };
    C.prototype.__rvPatchedSetZ = true;
  });
}

function patchEventCapture(){
  if(kakao.maps.event.__rvPatchedAdd) return;
  const origAdd = kakao.maps.event.addListener;
  kakao.maps.event.addListener = function(target, type, handler){
    if(overlayOn && !__rvIsWalker(target)) return null;
    return origAdd.call(this, target, type, handler);
  };
  kakao.maps.event.__rvPatchedAdd = true;
}

/* === RV Overlay Control === */
function setAllOverlaysZForRV(enable){
  __rvOverlayRegistry.forEach(o=>{
    if(!o || __rvIsWalker(o)) return;
    if(enable) o.setZIndex(1);
  });
}

/* === MapWalker === */
function MapWalker(position){
  const content=document.createElement('div');
  content.className='MapWalker';
  const walker=new kakao.maps.CustomOverlay({position,content,yAnchor:1,clickable:true});
  walker.setZIndex(999999);
  this.walker=walker;this.content=content;this.position=position;
}
MapWalker.prototype.setPosition=function(pos){this.position=pos;this.walker.setPosition(pos);}
MapWalker.prototype.setMap=function(map){this.walker.setMap(map);}

/* === Roadview Functions === */
function setRoadviewAt(pos){
  findNearestPanoId(pos,function(id){
    if(!id){ alert('로드뷰 없음'); return; }
    if(!document.getElementById('container').classList.contains('view_roadview')){
      document.getElementById('container').classList.add('view_roadview');
      map.relayout();
    }
    rv.setPanoId(id,pos);
    map.setCenter(pos);
    if(mapWalker) mapWalker.setPosition(pos);
  });
}

function findNearestPanoId(pos,cb){
  const dist=[50,100,200,400,800,1600];
  let i=0;
  (function next(){
    if(i>=dist.length) return cb(null);
    rvClient.getNearestPanoId(pos,dist[i],id=>{
      if(id) return cb(id);
      i++; next();
    });
  })();
}

/* === Toggle Overlay === */
function toggleOverlay(active){
  const btn=document.getElementById('roadviewControl');
  if(active){
    if(overlayOn) return;
    overlayOn=true;
    btn.classList.add('active');
    map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    setAllOverlaysZForRV(true);
    if(!mapWalker){
      mapWalker=new MapWalker(map.getCenter());
      mapWalker.setMap(map);
    }
    setRoadviewAt(map.getCenter());
  }else{
    if(!overlayOn) return;
    overlayOn=false;
    btn.classList.remove('active');
    map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    setAllOverlaysZForRV(false);
    if(mapWalker) mapWalker.setMap(null);
    document.getElementById('container').classList.remove('view_roadview');
    map.relayout();
  }
}

/* === 초기화 === */
kakao.maps.load(function(){
  map=new kakao.maps.Map(document.getElementById('map'),{
    center:new kakao.maps.LatLng(35.27253,128.406307),
    level:4
  });
  geocoder=new kakao.maps.services.Geocoder();
  places=new kakao.maps.services.Places();
  rvClient=new kakao.maps.RoadviewClient();
  rv=new kakao.maps.Roadview(document.getElementById('roadview'));

  // ✅ 패치들은 단 한 번만
  if(!window.__rvPatchedDone){
    patchOverlayZTracking();
    patchZIndexSetter();
    patchEventCapture();
    window.__rvPatchedDone=true;
  }

  // 로드뷰 이벤트
  kakao.maps.event.addListener(rv,'position_changed',()=>{
    if(overlayOn && mapWalker) mapWalker.setPosition(rv.getPosition());
  });

  // 버튼 연결
  document.getElementById('roadviewControl').addEventListener('click',()=>toggleOverlay(!overlayOn));
  document.getElementById('close').addEventListener('click',()=>toggleOverlay(false));

  // 위성뷰 토글
  const btnSat=document.getElementById('btnSatellite');
  btnSat.addEventListener('click',()=>{
    if(map.getMapTypeId()===kakao.maps.MapTypeId.ROADMAP){
      map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
      btnSat.classList.add('selected');
    }else{
      map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
      btnSat.classList.remove('selected');
    }
  });

  // 기존 마커/제안창 로드
  if(window.SEL_SUGGEST && typeof initMarkers==='function'){
    const uniq=new Map();
    const list=[];
    for(const it of window.SEL_SUGGEST){
      const lat=parseFloat(it.lat),lng=parseFloat(it.lng);
      if(!isFinite(lat)||!isFinite(lng)) continue;
      const key=lat+','+lng;
      if(uniq.has(key)) continue;
      uniq.set(key,true);
      list.push({
        latlng:new kakao.maps.LatLng(lat,lng),
        content:it.name1||it.name||'',
        group:it.group||null,
        __lat:lat,__lng:lng
      });
    }
    initMarkers(map,list);
  }

  if(typeof initSuggestUI==='function'){
    initSuggestUI({
      map,
      data:window.SEL_SUGGEST||[],
      parent:document.getElementById('mapWrapper'),
      getMarkers:()=>window.markers,
      badges:['line','enclosure','address','ip','group']
    });
  }
});
</script>
</body>
</html>
