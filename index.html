<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>GIS 모바일</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://hamancctv.github.io/2/favicon.ico" sizes="32x32"/>
  <link rel="stylesheet" href="https://hamancctv.github.io/2/style.css">
  <style>
    #mapWrapper { position: relative; }

    /* 검색창 + 제안창 */
    .gx-suggest-search{position:absolute;top:8px;left:50%;transform:translateX(-50%);display:flex;gap:8px;align-items:center;width:min(520px,90vw);z-index:600;}
    .gx-suggest-search input{flex:1;height:40px;padding:0 12px;border:1px solid #ccc;border-radius:10px;background:#fff;font-size:14px;outline:none;}
    .gx-suggest-search button{display:none;}
    .gx-suggest-box{position:absolute;top:48px;left:50%;transform:translateX(-50%) translateY(-6px);width:min(520px,90vw);max-height:40vh;overflow-y:auto;border:1px solid #ccc;border-radius:10px;background:rgba(255,255,255,0.96);box-shadow:0 8px 20px rgba(0,0,0,.15);z-index:610;opacity:0;pointer-events:none;transition:opacity .18s ease, transform .18s ease;display:block;}
    .gx-suggest-box.open{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto;}
    .gx-suggest-item{padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:8px;}
    .gx-suggest-item:hover,.gx-suggest-item.active{background:#eef3ff;}
    .gx-suggest-title{display:inline-block;max-width:60%;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-weight:600;}
    .gx-badge{font-size:12px;color:#555;background:#f2f4f8;padding:2px 6px;border-radius:6px;}
    .gx-suggest-empty{color:#777;padding:12px;}
  </style>
</head>
<body>
  <div id="alert-overlay"><div id="alert-message"></div></div>
  <button id="btnDistance">거리</button>

  <div id="container">
    <div id="rvWrapper">
      <div id="roadview" style="width:100%;height:100%;"></div>
      <div id="close" title="로드뷰닫기" onclick="closeRoadview()"><span class="img"></span></div>
    </div>
    <div id="mapWrapper">
      <div id="map" style="width:100%;height:100%"></div>
      <div id="roadviewControl" onclick="setRoadviewRoad()"></div>

      <!-- 검색창 + 제안창 -->
      <div class="gx-suggest-search">
        <input type="search" class="gx-input" placeholder="예) ㅎㅇㄱㅂㄱㅅ, ㄷ032, 시설명…" autocomplete="off" />
        <button type="button" class="gx-btn">검색</button>
      </div>
      <div class="gx-suggest-box"></div>
    </div>
  </div>

  <div class="toolbar-right">
    <input type="text" id="gpsyx" class="input-common" inputmode="none" value="35.2725308711779, 128.406307024695"/>
    <button id="btn_input_copy" class="btn-common">복사</button>
  </div>

  <div class="custom_typecontrol2_m radius_border">
    <span id="toggle_group" class="btn btn-common">회선</span>
    <span id="btnCurrentMe" class="btn btn-common" onclick="toggleMyLocation()">위치</span>
    <span id="btnTrackMe" class="btn btn-common" onclick="toggleTracking()">추적</span>
  </div>

  <!-- SDK & 외부 스크립트 -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services,clusterer,drawing&autoload=false"></script>
  <script src="https://code.jquery.com/jquery-3.6.1.js"></script>

  <!-- 외부 유틸 -->
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js"></script>
  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>
<script src="https://hamancctv.github.io/2/search-suggest.js"></script>
  
  <!-- ✅ 메인 스크립트 -->
  <script>
  kakao.maps.load(function () {
    const mapCenter=new kakao.maps.LatLng(35.2725308711779,128.406307024695);
    const map=new kakao.maps.Map(document.getElementById('map'),{center:mapCenter,level:4});
    map.setMaxLevel(9); window.map=map;

    // ===== 로드뷰 =====
    const rv=new kakao.maps.Roadview(document.getElementById('roadview'));
    const rvClient=new kakao.maps.RoadviewClient();
    let overlayOn=false;
    const rvMarker=new kakao.maps.Marker({
      image:new kakao.maps.MarkerImage(
        'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png',
        new kakao.maps.Size(26,46),
        {spriteSize:new kakao.maps.Size(1666,168),spriteOrigin:new kakao.maps.Point(705,114),offset:new kakao.maps.Point(13,46)}
      ),
      position:mapCenter,draggable:true
    });
    kakao.maps.event.addListener(rv,'position_changed',function(){const pos=rv.getPosition();map.setCenter(pos);if(overlayOn)rvMarker.setPosition(pos);});
    function toggleRoadview(position){rvClient.getNearestPanoId(position,50,function(id){if(!id)toggleMapWrapper(true,position);else{toggleMapWrapper(false,position);rv.setPanoId(id,position);}});}
    function toggleMapWrapper(active,pos){const c=document.getElementById('container');if(active){c.className='';map.relayout();map.setCenter(pos);}else{if(c.className.indexOf('view_roadview')===-1){map.relayout();map.setCenter(pos);}}}
    function toggleOverlay(active){if(active){overlayOn=true;map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);rvMarker.setMap(map);rvMarker.setPosition(map.getCenter());toggleRoadview(map.getCenter());}else{overlayOn=false;map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);rvMarker.setMap(null);}}
    window.setRoadviewRoad=function(){const c=document.getElementById('roadviewControl');if(c.className.indexOf('active')===-1){c.className='active';toggleOverlay(true);}else{c.className='';toggleOverlay(false);}};
    window.closeRoadview=function(){toggleMapWrapper(true,rvMarker.getPosition());};

    // ===== 내 위치 / 추적 =====
    let myLocationOn=false,trackOn=false,myMarker=null,trackMarker=null,trackInterval=null,watchId=null;
    const myImg=new kakao.maps.MarkerImage('https://hamancctv.github.io/2/icon-target.png',new kakao.maps.Size(32,32),{offset:new kakao.maps.Point(16,16)});
    window.toggleMyLocation=function(){if(trackOn)stopTracking();if(!myLocationOn){myLocationOn=true;document.getElementById('btnCurrentMe').classList.add('selected_btn');navigator.geolocation.getCurrentPosition(p=>showMyLocation(p.coords.latitude,p.coords.longitude),geoError,{enableHighAccuracy:true});}else{myLocationOn=false;document.getElementById('btnCurrentMe').classList.remove('selected_btn');if(myMarker){myMarker.setMap(null);myMarker=null;}}};
    function showMyLocation(lat,lng){const ll=new kakao.maps.LatLng(lat,lng);if(!myMarker){myMarker=new kakao.maps.Marker({position:ll,map:map,image:myImg});}else{myMarker.setPosition(ll);myMarker.setMap(map);}map.panTo(ll);map.setLevel(5);}
    window.toggleTracking=function(){if(myLocationOn)toggleMyLocation();if(!trackOn)startTracking();else stopTracking();};
    function startTracking(){trackOn=true;document.getElementById('btnTrackMe').classList.add('selected_btn');watchId=navigator.geolocation.watchPosition(p=>{const ll=new kakao.maps.LatLng(p.coords.latitude,p.coords.longitude);if(!trackMarker){trackMarker=new kakao.maps.Marker({position:ll,map:map,image:myImg});}else trackMarker.setPosition(ll);map.panTo(ll);},geoError,{enableHighAccuracy:true});trackInterval=setInterval(()=>{if(trackMarker)trackMarker.setVisible(!trackMarker.getVisible());},500);}
    function stopTracking(){trackOn=false;document.getElementById('btnTrackMe').classList.remove('selected_btn');if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;}if(trackInterval){clearInterval(trackInterval);trackInterval=null;}if(trackMarker){trackMarker.setVisible(true);trackMarker.setMap(null);trackMarker=null;}}
    function geoError(err){console.error("GPS error:",err);}

    // ===== 좌표 input 갱신/복사 =====
    kakao.maps.event.addListener(map,'center_changed',()=>{const ll=map.getCenter();$('#gpsyx').val(ll.getLat()+', '+ll.getLng());});
    document.getElementById("btn_input_copy").onclick=function(){const g=document.getElementById("gpsyx");g.select();document.execCommand('copy');};

    // ===== 마커 데이터 생성 =====
    const raw=(window.SEL_SUGGEST||[]).map(it=>{const lat=parseFloat(it.lat),lng=parseFloat(it.lng);if(!isFinite(lat)||!isFinite(lng))return null;return{latlng:new kakao.maps.LatLng(lat,lng),content:it.name1||it.name,searchName:it.name2||it.name,group:it.line||null};}).filter(Boolean);
    const unique=new Map();for(const p of raw){const key=p.latlng.getLat()+","+p.latlng.getLng();if(!unique.has(key))unique.set(key,p);}
    const finalPositions=[...unique.values()];
    if(window.initMarkers) initMarkers(map,finalPositions);


    if (window.initSuggestUI) {
  initSuggestUI({
    map,
    data: window.SEL_SUGGEST,
    parent: document.getElementById('mapWrapper'),
    getMarkers: () => window.markers,
    badges: ['line','encloser','addr','ip'],
    maxItems: 30,
    chooseOnEnter: true,
    openOnFocus: true
  });
}

    
    // ===== 검색 로직 연결 =====
    const box=document.querySelector('.gx-suggest-box');const kw=document.querySelector('.gx-input');
    function openBox(){box.classList.add('open');}function closeBox(){box.classList.remove('open');}
    kw.addEventListener('input',()=>{const v=kw.value.trim();if(!v){closeBox();return;}const items=(window.SEL_SUGGEST||[]).filter(it=>it.name1&&it.name1.includes(v));if(items.length){box.innerHTML=items.map(it=>`<div class="gx-suggest-item" data-lat="${it.lat}" data-lng="${it.lng}"><span class="gx-suggest-title">${it.name1}</span></div>`).join('');openBox();}else{box.innerHTML=`<div class="gx-suggest-empty">검색 결과 없음</div>`;openBox();}});
    box.addEventListener('mousedown',e=>{const el=e.target.closest('.gx-suggest-item');if(!el)return;const lat=parseFloat(el.dataset.lat),lng=parseFloat(el.dataset.lng);const m=(window.markers||[]).find(mm=>mm.__lat==lat&&mm.__lng==lng);if(m){kakao.maps.event.trigger(m,"mousedown");setTimeout(()=>kakao.maps.event.trigger(m,"mouseup"),0);map.panTo(m.getPosition());}closeBox();});
    document.addEventListener('click',e=>{if(!e.target.closest('.gx-suggest-search')&&!e.target.closest('.gx-suggest-box'))closeBox();});

    // ===== 회선 토글 =====
    const btn=document.getElementById("toggle_group");if(window.drawGroupLinesMST){btn.addEventListener("click",()=>{drawGroupLinesMST(map);btn.classList.toggle("selected_btn");});}
  });
  </script>
</body>
</html>
