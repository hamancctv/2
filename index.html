<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>GIS 모바일</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://hamancctv.github.io/2/favicon.ico" sizes="32x32"/>
  <link rel="stylesheet" href="https://hamancctv.github.io/2/style.css">
  <style>
    html, body, #container, #mapWrapper, #map, #rvWrapper, #roadview {
      height:100vh;
      margin:0; padding:0;
    }
    #mapWrapper { position: relative; }

    /* 검색창 */
    .gx-suggest-search {
      position:absolute;
      top:8px;
      left:0; right:0;
      margin:0 auto;
      display:flex;
      gap:8px;
      align-items:center;
      width:min(520px,90vw);
      z-index:600;
      justify-content:center;
    }
    .gx-suggest-search input.gx-input {
      flex:1;
      height:42px;
      padding:0 14px;
      border:1px solid #ccc;
      border-radius:12px;
      background:#fff;
      font-size:15px;
      outline:none;
      box-sizing:border-box;
      transition:border .2s ease, box-shadow .2s ease;
    }
    .gx-suggest-search input.gx-input:focus {
      border-color:#4a90e2;
      box-shadow:0 0 0 2px rgba(74,144,226,0.2);
    }
    .gx-suggest-search button.gx-btn { display:none; }

    /* 제안창 (애니메이션 포함) */
    .gx-suggest-box {
      position:absolute;
      top:52px; left:50%;
      transform:translateX(-50%) translateY(-8px); /* 처음엔 살짝 위 */
      width:min(520px,90vw);
      max-height:45vh;
      overflow-y:auto;
      -webkit-overflow-scrolling: touch;
      background:#fff;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
      z-index:610;
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease, transform .25s ease;
      display:block;
    }
    .gx-suggest-box.open {
      opacity:1;
      transform:translateX(-50%) translateY(0); /* 자연스럽게 내려옴 */
      pointer-events:auto;
    }

    /* 항목 */
    .gx-suggest-item {
      padding:12px 16px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:4px;
      border-bottom:1px solid #f0f0f0;
      transition: background .2s ease;
    }
    .gx-suggest-item:last-child { border-bottom:none; }
    .gx-suggest-item:hover,
    .gx-suggest-item.active {
      background:#f7faff;
    }

    /* 제목 */
    .gx-suggest-title {
      font-weight:600;
      font-size:15px;
      color:#222;
      line-height:1.3;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* 부제 */
    .gx-suggest-sub {
      font-size:13px;
      color:#666;
      line-height:1.2;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* 펄스 효과 */
    .pulse-marker {
      width:20px; height:20px;
      margin-left:-10px; margin-top:-10px;
      border:4px solid red; border-radius:50%;
      background:rgba(255,0,0,0.3);
      animation:pulse 1.2s ease-out forwards;
    }
    @keyframes pulse {
      0%{transform:scale(0.5);opacity:0.8;}
      70%{transform:scale(2.0);opacity:0;}
      100%{transform:scale(2.0);opacity:0;}
    }

    /* 숨김 클래스 (로드뷰 전환 시) */
    .gx-hidden { display:none !important; }
  </style>
</head>
<body>
  <div id="alert-overlay"><div id="alert-message"></div></div>

  <div id="container">
    <div id="rvWrapper" style="display:none;">
      <div id="roadview"></div>
      <div id="close" title="로드뷰닫기" onclick="closeRoadview()"><span class="img"></span></div>
    </div>
    <div id="mapWrapper">
      <div id="map"></div>
      <div id="roadviewControl"></div>

      <!-- 검색창 + 제안창 -->
      <div class="gx-suggest-search">
        <input type="search" class="gx-input" placeholder="예) ㅎㅇㄱㅂㄱㅅ, ㄷ032, 시설명…" autocomplete="off" />
        <button type="button" class="gx-btn">검색</button>
      </div>
      <div class="gx-suggest-box"></div>
    </div>
  </div>

  <div class="toolbar-right" style="display:none;">
    <input type="text" id="gpsyx" class="input-common" inputmode="none"
           value="35.2725308711779, 128.406307024695"/>
    <button id="btn_input_copy" class="btn-common">복사</button>
  </div>

  <!-- SDK & 외부 스크립트 -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services,clusterer,drawing&autoload=false"></script>
  <script src="https://code.jquery.com/jquery-3.6.1.js"></script>

  <!-- 외부 유틸 -->
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js"></script>
  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>
  <script src="https://hamancctv.github.io/2/search-suggest.js"></script>

  <!-- ✅ 로드뷰 토글 함수 -->
  <script>
  function openRoadview(map, position) {
    const rvWrapper = document.getElementById('rvWrapper');
    const mapWrapper = document.getElementById('mapWrapper');

    // 검색창 숨김
    mapWrapper.querySelector('.gx-suggest-search').classList.add('gx-hidden');
    mapWrapper.querySelector('.gx-suggest-box').classList.add('gx-hidden');

    rvWrapper.style.display = 'block';
    mapWrapper.style.display = 'none';

    const rv = new kakao.maps.Roadview(document.getElementById('roadview'));
    const rvClient = new kakao.maps.RoadviewClient();
    rvClient.getNearestPanoId(position, 50, function(panoId) {
      if (panoId) rv.setPanoId(panoId, position);
    });
  }

  function closeRoadview() {
    const rvWrapper = document.getElementById('rvWrapper');
    const mapWrapper = document.getElementById('mapWrapper');

    rvWrapper.style.display = 'none';
    mapWrapper.style.display = 'block';

    // 검색창 복원
    mapWrapper.querySelector('.gx-suggest-search').classList.remove('gx-hidden');
    mapWrapper.querySelector('.gx-suggest-box').classList.remove('gx-hidden');
  }
  </script>

  <!-- ✅ 메인 스크립트 -->
  <script>
  kakao.maps.load(function () {
    const mapCenter=new kakao.maps.LatLng(35.2725308711779,128.406307024695);
    const map=new kakao.maps.Map(document.getElementById('map'),{center:mapCenter,level:4});
    map.setMaxLevel(9); 
    window.map=map;
    
    // ✅ 마커 생성
    const raw = (window.SEL_SUGGEST || []).map(it => {
      const lat = parseFloat(it.lat), lng = parseFloat(it.lng);
      if (!isFinite(lat) || !isFinite(lng)) return null;
      return {
        latlng: new kakao.maps.LatLng(lat, lng),
        content: it.name1 || it.name,
        searchName: it.name2 || it.name,
        group: it.line || null
      };
    }).filter(Boolean);

    const unique = new Map();
    for (const p of raw) {
      const key = p.latlng.getLat() + "," + p.latlng.getLng();
      if (!unique.has(key)) unique.set(key, p);
    }
    const finalPositions = [...unique.values()];

    if (window.initMarkers) {
      initMarkers(map, finalPositions);
    }

    // ✅ 좌표 input 갱신/복사
    kakao.maps.event.addListener(map,'center_changed',()=>{
      const ll=map.getCenter();
      $('#gpsyx').val(ll.getLat()+', '+ll.getLng());
    });
    document.getElementById("btn_input_copy").onclick=function(){
      const g=document.getElementById("gpsyx");
      g.select();
      document.execCommand('copy');
    };

    // ✅ 검색창 초기화
    if (window.initSuggestUI) {
      initSuggestUI({
        map: map,
        data: window.SEL_SUGGEST,
        parent: document.getElementById('mapWrapper'),
        getMarkers: () => window.markers,
        badges: ['line','encloser','addr','ip'],
        maxItems: 30,
        chooseOnEnter: true,
        openOnFocus: true
      });
    }

    // ✅ 회선 토글
    const btn=document.getElementById("toggle_group");
    if(window.drawGroupLinesMST && btn){
      btn.addEventListener("click",()=>{
        drawGroupLinesMST(map);
        btn.classList.toggle("selected_btn");
      });
    }
  });
  </script>
</body>
</html>
