<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>GIS 라이트</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>
<link rel="stylesheet" href="https://hamancctv.github.io/2/style.css" />
<style>
  html, body { height:100%; margin:0; }
  #container { position:relative; height:100%; overflow:hidden; }
  #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
  #map { width:100%; height:100%; }

  /* ✅ 로드뷰 z-index 수정 */
  #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
  .view_roadview #rvWrapper { display:block; z-index:0; }
  .view_roadview #mapWrapper {
    position:absolute; left:8px; bottom:8px;
    width:26%; height:26%;
    min-width:200px; min-height:150px;
    border:2px solid #ccc; border-radius:8px; background:#fff; z-index:3;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }

  #close {
    position:absolute; top:8px; left:8px;
    padding:6px; background:#fff; border:1px solid #c8c8c8; border-radius:6px;
    cursor:pointer; z-index:4; box-shadow:0 1px #888;
  }
  #close .img {
    display:block; width:14px; height:14px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/rv_close.png) no-repeat;
  }

  .toolbar { position:fixed; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:10; }
  .btn-satellite {
    width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #ccc; border-radius:8px; background:#fff; color:#555;
    cursor:pointer; transition:all .2s ease; box-sizing:border-box;
  }
  .btn-satellite:hover { box-shadow:0 3px 12px rgba(0,0,0,.12); }
  .btn-satellite.selected { border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff; }
  .btn-satellite svg { width:18px; height:18px; display:block; }
  .btn-satellite svg circle { fill:currentColor; }

  #roadviewControl{
    width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#fff !important;
    color:#555; transition:all .2s ease; box-sizing:border-box;
  }
  #roadviewControl:hover{ box-shadow:0 3px 12px rgba(0,0,0,.12); }
  #roadviewControl.active{
    border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff;
  }
  #roadviewControl::before{
    content:""; width:18px; height:18px; border-radius:50%;
    display:block; background: radial-gradient(#fff 0 28%, currentColor 29% 100%);
  }

  /* ✅ 리사이저 클릭 차단 */
  #mapWrapper .rv-resizer{
    position:absolute; right:6px; top:6px;
    width:16px; height:16px; border:1px solid #bbb; border-radius:4px; background:#fff;
    box-shadow:0 1px 3px rgba(0,0,0,.2); z-index:650;
    cursor: nesw-resize;
    pointer-events:none;
  }
  .view_roadview #mapWrapper .rv-resizer{ display:block; }

  .MapWalker {position:absolute; margin:-26px 0 0 -51px; cursor:grab; z-index:2147483647;}
  .MapWalker.dragging{ cursor:grabbing; }
  .MapWalker .figure {
    position:absolute; width:25px; left:38px; top:-2px; height:39px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png) -298px -114px no-repeat;
    pointer-events:none;
  }
  .MapWalker .angleBase,.MapWalker .angleFront{
    position:absolute; left:0; top:0; width:102px; height:52px;
    background-image:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png);
    background-repeat:no-repeat;
    filter: sepia(1) saturate(5.5) hue-rotate(8deg) brightness(1.12) contrast(0.98);
  }
  .MapWalker .angleBase{ background-position:-834px -2px; opacity:.18; }
  .MapWalker .angleFront{ opacity:.92; }
</style>
</head>
<body>
  <div id="container">
    <div id="mapWrapper">
      <div id="map"></div>
      <div class="toolbar">
        <button id="btnSatellite" class="btn-satellite" title="위성뷰">
          <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"/></svg>
        </button>
        <button id="roadviewControl" title="로드뷰"></button>
      </div>
      <div class="rv-resizer" aria-hidden="true"></div>
    </div>
    <div id="rvWrapper"><div id="roadview"></div></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>

  <!-- 인터랙션 잠금 제어 -->
  <script>
  window.__interactionLock=false;
  window.isInteractionLocked=()=>window.__interactionLock===true;
  window.setInteractionLock=(s)=>{window.__interactionLock=!!s;console.log(`[interactionLock] ${s?"LOCKED":"UNLOCKED"}`);}
  </script>

  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>
  <script src="https://hamancctv.github.io/2/search-suggest.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js"></script>

<script>
/* ======== 초기화 및 로드뷰 로직 ======== */
kakao.maps.load(function(){
  const center = new kakao.maps.LatLng(35.2725308711779,128.406307024695);
  map = new kakao.maps.Map(document.getElementById('map'), {center, level:4});
  map.setMaxLevel(9);

  geocoder = new kakao.maps.services.Geocoder();
  places = new kakao.maps.services.Places();
  rvClient = new kakao.maps.RoadviewClient();
  rv = new kakao.maps.Roadview(document.getElementById('roadview'));

  let overlayOn = false;
  let mapWalker = null;
  const rvBtn = document.getElementById('roadviewControl');

  function setRoadviewAt(position){
    rvClient.getNearestPanoId(position, 50, function(panoId){
      if(panoId) rv.setPanoId(panoId, position);
    });
  }

  function toggleOverlay(active){
    const container = document.getElementById('container');
    if(active){
      overlayOn = true;
      rvBtn.classList.add('active');
      container.classList.add('view_roadview');
      setInteractionLock(true);

      if(!mapWalker){
        mapWalker = new MapWalker(map.getCenter());
        mapWalker.setMap(map);
      }else{
        mapWalker.setPosition(map.getCenter());
        mapWalker.setMap(map);
      }
      setRoadviewAt(map.getCenter());
    }else{
      overlayOn = false;
      rvBtn.classList.remove('active');
      container.classList.remove('view_roadview');
      setInteractionLock(false);

      if(mapWalker) mapWalker.setMap(null);
    }
  }

  rvBtn.addEventListener('click', ()=>toggleOverlay(!overlayOn));

  rv.addListener('position_changed', function(){
    if(mapWalker && overlayOn){
      const pos = rv.getPosition();
      mapWalker.setPosition(pos);
      map.setCenter(pos);
    }
  });

  // ===== MapWalker 정의 =====
  function MapWalker(position){
    this.content = document.createElement('div');
    this.content.className = 'MapWalker';
    this.content.innerHTML = `
      <div class="angleBase"></div>
      <div class="angleFront"></div>
      <div class="figure"></div>`;
    this.overlay = new kakao.maps.CustomOverlay({
      position: position, content: this.content, yAnchor: 1
    });
    this.setMap = (map)=>{ this.overlay.setMap(map); };
    this.setPosition = (pos)=>{ this.overlay.setPosition(pos); this.position = pos; };
    this.position = position;
  }

  // 로드뷰 닫기용 ESC 핸들러
  document.addEventListener('keydown', e=>{
    if(e.key==='Escape' && overlayOn) toggleOverlay(false);
  });
});
</script>
</body>
</html>
