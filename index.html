<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>CCTV GIS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <!-- Kakao Maps (deferred, autoload=false) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>

  <!-- Í≥µÏö© Ïä§ÌÉÄÏùº -->
  <link rel="stylesheet" href="style.css"/>

  <style>
    html, body { height:100%; margin:0; }
    #container { position:relative; height:100%; overflow:hidden; }
    #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
    #map { width:100%; height:100%; cursor:grab; }
    #map:active { cursor:grabbing; }

    /* Ìà¥Î∞î */
    .toolbar {
      position:fixed; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:10;
    }
    .toolbar button {
      width:42px; height:42px; display:flex; align-items:center; justify-content:center;
      font-size:22px; border:1px solid #ccc; border-radius:10px;
      background:linear-gradient(180deg,#fff 0%,#f8f8f8 100%); color:#333;
      cursor:pointer; transition:.25s; box-shadow:0 2px 5px rgba(0,0,0,.1);
    }
    .toolbar button:hover { transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,.18); }
    .toolbar button.active {
      border-color:#007aff; color:#007aff;
      background:linear-gradient(180deg,#eaf3ff 0%,#d7e9ff 100%);
      box-shadow:0 0 0 3px rgba(0,122,255,.15) inset, 0 3px 10px rgba(0,0,0,.12);
      transform:translateY(1px);
    }

    /* Î°úÎìúÎ∑∞ */
    #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
    #roadview  { width:100%; height:100%; }
    .view_roadview #rvWrapper { display:block; z-index:1; }
    .view_roadview #mapWrapper {
      position:absolute; left:8px; bottom:8px; width:26%; height:26%; min-width:200px; min-height:150px;
      border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2; box-shadow:0 8px 24px rgba(0,0,0,.2);
    }

  </style>
</head>

<body>
  <!-- ÏßÄÎèÑ Ïª®ÌÖåÏù¥ÎÑà -->
  <div id="container">
    <div id="mapWrapper">
      <div id="map"></div>

      <div class="toolbar">
        <button id="btnSatellite" title="ÏúÑÏÑ±Î∑∞">üåê</button>
        <button id="roadviewControl" title="Î°úÎìúÎ∑∞">üöó</button>
        <button id="btnDistance" title="Í±∞Î¶¨Ïû¨Í∏∞">üìè</button>
        <button id="btnGroupMST" title="Í∑∏Î£πÏó∞Í≤∞">üß©</button>
        <button id="btnCapture" class="capture-btn" title="ÏßÄÎèÑ Ï∫°Ï≤ò">üì∑</button>
      </div>

    </div>

    <div id="rvWrapper"><div id="roadview"></div></div>
  </div>

  <!-- Í≥µÌÜµ Ïú†Ìã∏ -->
  <script>
    function setAllMarkersClickable(clickable){
      const list = window.markers || [];
      for (const m of list) { try { m.setClickable(clickable); } catch(e){} }
    }
    function flash(msg){
      const el=document.createElement('div');
      el.textContent=msg;
      el.style.cssText='position:fixed;left:50%;top:14px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;z-index:99999;pointer-events:none';
      document.body.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .25s'; },1100);
      setTimeout(()=>el.remove(),1500);
    }
  </script>

  <!-- Í∏∞Îä• Î™®Îìà -->
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="sel_suggest.js"></script>
  <script src="markers-handler.js"></script>
  <script src="search-suggest.js"></script>
  <script src="drawGroupLinesMST.js"></script>
  <script src="btnDistance.js"></script>
  <script src="roadview.js"></script>
  <script src="btnCapture.js"></script>

  <!-- ÏßÄÎèÑ Î°úÎìú -->
  <script>
    let map, geocoder, places;

    document.addEventListener('DOMContentLoaded', () => {
      kakao.maps.load(initMap);
    });

    function initMap(){
      const center = new kakao.maps.LatLng(35.2725308711779, 128.406307024695);
      map = new kakao.maps.Map(document.getElementById('map'), { center, level:4 });
      window.map = map;
      map.setMaxLevel(9);
      geocoder = new kakao.maps.services.Geocoder();
      places   = new kakao.maps.services.Places();

      // Î°úÎìúÎ∑∞
      const rvDiv = document.getElementById('roadview');
      const rv = new kakao.maps.Roadview(rvDiv);
      const rvClient = new kakao.maps.RoadviewClient();
      window.__rvInstance = rv;
      window.__rvClient   = rvClient;

      if (window.RoadviewModule?.initRoadview)
        RoadviewModule.initRoadview(map, rv, rvClient);

      // Í±∞Î¶¨Ïû¨Í∏∞
      if (window.DistanceModule?.setupDistance)
        DistanceModule.setupDistance(map);

      // ÎßàÏª§
      if (window.SEL_SUGGEST && typeof initMarkers === 'function'){
        const unique = new Map(), positions=[];
        for (const it of window.SEL_SUGGEST){
          const lat = +it.lat, lng = +it.lng;
          if (!isFinite(lat) || !isFinite(lng)) continue;
          const key = lat+','+lng; if (unique.has(key)) continue; unique.set(key,true);
          positions.push({
            latlng: new kakao.maps.LatLng(lat,lng),
            content: it.name1 || it.name || '',
            searchName: it.name2 || it.name || '',
            group: it.group || null,
            __lat: lat, __lng: lng
          });
        }
        initMarkers(map, positions);
      }

      // Í≤ÄÏÉâ Ï†úÏïà
      if (typeof initSuggestUI === 'function'){
        initSuggestUI({
          map,
          data: window.SEL_SUGGEST || [],
          parent: document.getElementById('mapWrapper'),
          getMarkers: () => window.markers,
          badges: ['line','enclosure','address','ip','group'],
          maxItems: 30, chooseOnEnter: true, openOnFocus: true
        });
      }

      // Ìà¥Î∞î Í∏∞Îä• Ïó∞Í≤∞
      wireToolbar(map, rv, rvClient);
    }

    function wireToolbar(map, rv, rvClient){
      const btnSat  = document.getElementById('btnSatellite');
      const btnRV   = document.getElementById('roadviewControl');
      const btnDist = document.getElementById('btnDistance');
      const btnMST  = document.getElementById('btnGroupMST');

      btnSat?.addEventListener('click', ()=>{
        const isRoad = map.getMapTypeId() === kakao.maps.MapTypeId.ROADMAP;
        map.setMapTypeId(isRoad ? kakao.maps.MapTypeId.HYBRID : kakao.maps.MapTypeId.ROADMAP);
        btnSat.classList.toggle('active', isRoad);
      });

      btnRV?.addEventListener('click', ()=>{
        if (window.RoadviewModule?.toggle){
          RoadviewModule.toggle();
        } else {
          const body = document.body;
          if (body.classList.contains('view_roadview')){
            body.classList.remove('view_roadview');
          } else {
            const pos = map.getCenter();
            rvClient.getNearestPanoId(pos, 50, panoId=>{
              if (!panoId) return flash('Ï£ºÎ≥Ä Î°úÎìúÎ∑∞ ÏóÜÏùå');
              rv.setPanoId(panoId, pos);
              body.classList.add('view_roadview');
            });
          }
        }
      });

      btnDist?.addEventListener('click', ()=>{
        if (window.DistanceModule?.toggleDistance){
          DistanceModule.toggleDistance();
          btnDist.classList.toggle('active');
        } else {
          flash('Í±∞Î¶¨Ïû¨Í∏∞ Î™®Îìà(btnDistance.js) ÏóÜÏùå');
        }
      });

      (function(){
        if (!btnMST) return;
        let active = false;
        function normalizeMarkers(){
          (window.markers || []).filter(Boolean).forEach(mk=>{
            const gx = mk.gx || {};
            mk.group = mk.group ?? gx.group ?? gx.grp ?? null;
            mk.name  = mk.name  ?? gx.content ?? gx.searchName ?? gx.name ?? '';
          });
        }
        window.getMarkersByGroup = window.getMarkersByGroup || function(){
          const by={}; (window.markers||[]).forEach(mk=>{
            const g = (mk.group ?? mk.gx?.group ?? null);
            if (!g) return; (by[g] ||= []).push(mk);
          }); return by;
        };
        btnMST.addEventListener('click', ()=>{
          active = !active; btnMST.classList.toggle('active', active);
          if (active){
            if (btnDist?.classList.contains('active')) btnDist.click();
            normalizeMarkers();
            if (typeof drawMSTAllGroups === 'function'){ drawMSTAllGroups(map); }
            else flash('drawGroupLinesMST.js ÏóÜÏùå');
          } else {
            if (typeof clearMSTLines === 'function') clearMSTLines();
          }
        });
      })();
    }
  </script>
</body>
</html>
