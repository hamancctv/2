<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>GIS ë¼ì´íŠ¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

<!-- Kakao Maps SDK (services + ìˆ˜ë™ ë¡œë“œ) -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>

<!-- ê¸°ì¡´ ìŠ¤íƒ€ì¼ -->
<link rel="stylesheet" href="https://hamancctv.github.io/2/style.css" />

<style>
  html, body { height:100%; margin:0; }
  #container { position:relative; height:100%; overflow:hidden; }
  #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
  #map { width:100%; height:100%; }

  /* ë¡œë“œë·° ì „ì²´í™”ë©´(ì§€ë„ëŠ” ë¯¸ë‹ˆë§µ) */
  #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
  #roadview  { width:100%; height:100%; }
  .view_roadview #rvWrapper { display:block; z-index:1; }
  .view_roadview #mapWrapper {
    position:absolute; left:8px; bottom:8px;
    width:26%; height:26%;
    min-width:200px; min-height:150px;
    border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }

  /* ë¡œë“œë·° ë‹«ê¸° */
  #close {
    position:absolute; top:8px; left:8px;
    padding:6px; background:#fff; border:1px solid #c8c8c8; border-radius:6px;
    cursor:pointer; z-index:3; box-shadow:0 1px #888;
  }
  #close .img {
    display:block; width:14px; height:14px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/rv_close.png) no-repeat;
  }

  /* ì¢Œì¸¡ íˆ´ë°” */
  .toolbar { position:absolute; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:620; }

  /* ìœ„ì„±ë·° ë²„íŠ¼(40Ã—40) */
  .btn-satellite {
    width:40px; height:40px;
    display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #ccc; border-radius:8px; background:#fff; color:#555;
    cursor:pointer; transition:all .2s ease; box-sizing:border-box;
  }
  .btn-satellite:hover { box-shadow:0 3px 12px rgba(0,0,0,.12); }
  .btn-satellite.selected { border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff; }
  .btn-satellite svg { width:18px; height:18px; display:block; }
  .btn-satellite svg circle { fill:currentColor; }

  /* ë¡œë“œë·° ë²„íŠ¼(40Ã—40, CSS ì•„ì´ì½˜) */
  #roadviewControl{
    width:40px; height:40px;
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer;
    border:1px solid #ccc; border-radius:8px; background:#fff !important;
    background-image:none !important;
    color:#555; transition:all .2s ease; box-sizing:border-box;
  }
  #roadviewControl:hover{ box-shadow:0 3px 12px rgba(0,0,0,.12); }
  #roadviewControl.active{
    border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff;
  }
  #roadviewControl::before{
    content:"";
    width:18px; height:18px; border-radius:50%;
    display:block;
    background: radial-gradient(#fff 0 28%, currentColor 29% 100%);
  }

  /* ë¯¸ë‹ˆë§µ í¬ê¸°ì¡°ì ˆ í•¸ë“¤ (ì˜¤ë¥¸ìª½ ìœ„, ìœ„ë¡œ/ì˜¤ë¥¸ìª½ìœ¼ë¡œ ëŒë©´ ì»¤ì§) */
  #mapWrapper .rv-resizer{
    position:absolute; right:6px; top:6px;
    width:16px; height:16px;
    border:1px solid #bbb; border-radius:4px; background:#fff;
    box-shadow:0 1px 3px rgba(0,0,0,.2);
    cursor: nesw-resize;
    z-index:650; display:none;
  }
  #mapWrapper .rv-resizer::before{
    content:""; position:absolute; inset:2px;
    background: linear-gradient(135deg, transparent 50%, #888 0) no-repeat;
    opacity:.7;
  }
  .view_roadview #mapWrapper .rv-resizer{ display:block; }
</style>
</head>
<body>
  <div id="container">
    <!-- ì§€ë„ -->
    <div id="mapWrapper">
      <div id="map"></div>

      <!-- ì¢Œì¸¡ íˆ´ë°”: ìœ„ì„±ë·° + ë¡œë“œë·°(CSSë²„íŠ¼) -->
      <div class="toolbar">
        <button id="btnSatellite" class="btn-satellite" title="ìœ„ì„±ë·°">
          <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"/></svg>
        </button>
        <button id="roadviewControl" title="ë¡œë“œë·°"></button>
      </div>

      <!-- ê²€ìƒ‰ -->
    </div> <!-- ğŸ”’ mapWrapper ë‹«ê¸° -->

    <!-- ë¡œë“œë·°(ì „ì²´í™”ë©´) -->
    <div id="rvWrapper">
      <div id="roadview"></div>
      <div id="close" title="ë¡œë“œë·° ë‹«ê¸°"><span class="img"></span></div>
    </div>
  </div>

  <!-- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ë“¤ -->
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js"></script>
  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>
  <script src="https://hamancctv.github.io/2/search-suggest.js"></script>

<script>
/* ì§§ì€ í—¬í¼ */
const $  = s => document.querySelector(s);

/* ì „ì—­ */
let map, geocoder, places;
let overlayOn = false, rv, rvClient, rvMarker;

/* ë¡œë“œë·° ë§ˆì»¤ ì´ë¯¸ì§€ */
function rvMarkerImage(){
  return new kakao.maps.MarkerImage(
    'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png',
    new kakao.maps.Size(26, 46),
    {
      spriteSize: new kakao.maps.Size(1666, 168),
      spriteOrigin: new kakao.maps.Point(705, 114),
      offset: new kakao.maps.Point(13, 46)
    }
  );
}

/* ğŸ” ë°˜ê²½ì„ í‚¤ì›Œê°€ë©° ê°€ì¥ ê°€ê¹Œìš´ ë¡œë“œë·° panoId ì°¾ê¸° */
function findNearestPanoId(position, cb, radii=[50,100,200,400,800,1600,3000]) {
  let i = 0;
  (function tryNext(){
    if (i >= radii.length) return cb(null);
    rvClient.getNearestPanoId(position, radii[i], function(panoId){
      if (panoId) return cb(panoId);
      i++; tryNext();
    });
  })();
}

/* ğŸ”” ê°„ë‹¨ í† ìŠ¤íŠ¸ */
function flash(msg) {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText =
    'position:fixed;left:50%;top:14px;transform:translateX(-50%);' +
    'background:rgba(0,0,0,.75);color:#fff;padding:8px 12px;border-radius:8px;' +
    'font-size:13px;z-index:9999;pointer-events:none';
  document.body.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .3s'; }, 1200);
  setTimeout(()=> el.remove(), 1600);
}

/* âœ… ë¡œë“œë·° ìœ„ì¹˜ ì„¸íŒ…: ê·¼ì²˜ ì—†ìœ¼ë©´ ê°€ì¥ ê°€ê¹Œìš´ ê³³ìœ¼ë¡œ ìŠ¤ëƒ… */
function setRoadviewAt(position){
  const container = document.getElementById('container');

  findNearestPanoId(position, function(panoId){
    if (!panoId) {
      flash('ê·¼ì²˜ì— ë¡œë“œë·°ê°€ ì—†ì–´ìš”');
      try { map.setCenter(position); } catch(e){}
      try { if (rvMarker) rvMarker.setPosition(position); } catch(e){}
      return;
    }

    if (!container.classList.contains('view_roadview')) {
      container.classList.add('view_roadview');
      map.relayout();
    }

    try { map.setCenter(position); } catch(e){}
    try { if (rvMarker) rvMarker.setPosition(position); } catch(e){}

    rv.setPanoId(panoId, position);
  });
}

/* ë¡œë“œë·° ì˜¤ë²„ë ˆì´ í† ê¸€ */
function toggleOverlay(active){
  const btn = document.getElementById('roadviewControl');
  if(active){
    overlayOn = true;
    btn.classList.add('active');
    map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);

    if(!rvMarker){
      rvMarker = new kakao.maps.Marker({
        position: map.getCenter(),
        draggable: true,
        image: rvMarkerImage()
      });
      kakao.maps.event.addListener(rvMarker, 'dragend', ()=> setRoadviewAt(rvMarker.getPosition()));
    }
    rvMarker.setMap(map);
    rvMarker.setPosition(map.getCenter());
    setRoadviewAt(map.getCenter());

    // âœ… ë¡œë“œë·° ì²˜ìŒ ì¼°ì„ ë•Œ ë™ë™ì´ ê°ë„ ì´ˆê¸°í™”
    setTimeout(syncRvMarkerAngle, 80);
  }else{
    overlayOn = false;
    btn.classList.remove('active');
    map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    if(rvMarker) rvMarker.setMap(null);
    document.getElementById('container').classList.remove('view_roadview');
    map.relayout();
  }
}

/* ì´ˆê¸°í™” */
kakao.maps.load(function(){
  const center = new kakao.maps.LatLng(35.2725308711779, 128.406307024695);
  map = new kakao.maps.Map(document.getElementById('map'), { center, level:4 });
  map.setMaxLevel(9);

  geocoder = new kakao.maps.services.Geocoder();
  places   = new kakao.maps.services.Places();
  rvClient = new kakao.maps.RoadviewClient();
  rv       = new kakao.maps.Roadview(document.getElementById('roadview'));

  /* === ë™ë™ì´(ë¡œë“œë·° ë§ˆì»¤) íšŒì „ ë™ê¸°í™” === */
  function syncRvMarkerAngle(){
    try {
      if (!rv || !rvMarker) return;
      const vp = rv.getViewpoint();             // { pan, tilt, zoom }
      if (typeof rvMarker.setAngle === 'function') {
        rvMarker.setAngle(vp.pan);              // ë¡œë“œë·° ì‹œì„  ë°©í–¥ìœ¼ë¡œ íšŒì „
      }
    } catch (e) {}
  }
  kakao.maps.event.addListener(rv, 'viewpoint_changed', function(){
    if (!overlayOn || !rvMarker) return;
    syncRvMarkerAngle();
  });
  kakao.maps.event.addListener(rv, 'panoid_changed', function(){
    if (!overlayOn || !rvMarker) return;
    syncRvMarkerAngle();
  });

  // ë¡œë“œë·° â†” ì§€ë„ ì‹±í¬(ìœ„ì¹˜)
  kakao.maps.event.addListener(rv, 'position_changed', function(){
    if(!overlayOn) return;
    const pos = rv.getPosition();
    map.setCenter(pos);
    if(rvMarker) rvMarker.setPosition(pos);
  });

  // ì§€ë„ í´ë¦­ â†’ ë¡œë“œë·° ì´ë™(ì¼œì ¸ ìˆì„ ë•Œë§Œ)
  kakao.maps.event.addListener(map, 'click', function(e){
    if(!overlayOn) return;
    const pos = e.latLng;
    if(rvMarker) rvMarker.setPosition(pos);
    setRoadviewAt(pos);
  });

  // ë¡œë“œë·° ë²„íŠ¼(ìƒˆ CSS ì•„ì´ì½˜) í´ë¦­
  document.getElementById('roadviewControl').addEventListener('click', ()=>{
    toggleOverlay(!overlayOn);
  });

  // ë‹«ê¸° ë²„íŠ¼
  document.getElementById('close').addEventListener('click', ()=> toggleOverlay(false));

  // ìœ„ì„±ë·° í† ê¸€
  const btnSat = document.getElementById('btnSatellite');
  btnSat.addEventListener('click', ()=>{
    if(map.getMapTypeId() === kakao.maps.MapTypeId.ROADMAP){
      map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
      btnSat.classList.add('selected');
    }else{
      map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
      btnSat.classList.remove('selected');
    }
  });

  /* ====== ê¸°ì¡´ ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ì™€ì˜ ì—°ë™ ====== */

  // 1) ë§ˆì»¤ ìƒì„±(ì™¸ë¶€ handlers)
  if (window.SEL_SUGGEST && typeof initMarkers === 'function') {
    const unique = new Map();
    const positionsLike = [];
    for (const it of window.SEL_SUGGEST) {
      const lat = parseFloat(it.lat), lng = parseFloat(it.lng);
      if (!isFinite(lat) || !isFinite(lng)) continue;
      const key = lat + ',' + lng;
      if (unique.has(key)) continue;
      unique.set(key, true);
      positionsLike.push({
        latlng: new kakao.maps.LatLng(lat, lng),
        content: it.name1 || it.name || '',
        searchName: it.name2 || it.name || '',
        group: it.line || null
      });
    }
    initMarkers(map, positionsLike);
  }

  // 2) ê²€ìƒ‰ ì œì•ˆ(ì™¸ë¶€ search-suggest.jsê°€ ì œê³µ)
  if (typeof initSuggestUI === 'function') {
    initSuggestUI({
      map,
      data: window.SEL_SUGGEST || [],
      parent: document.getElementById('mapWrapper'),
      getMarkers: () => window.markers,
      badges: ['line','encloser','addr','ip'],
      maxItems: 30,
      chooseOnEnter: true,
      openOnFocus: true
    });
  }

  /* ===== ë¯¸ë‹ˆë§µ(ë¡œë“œë·°ì‹œ) í¬ê¸° ì¡°ì ˆ ===== */
  (function setupMiniMapResizer(){
    const container = document.getElementById('container');
    const wrapper   = document.getElementById('mapWrapper');

    // í•¸ë“¤ ìƒì„± (HTML ìˆ˜ì • ì—†ì´ JSë¡œ ì£¼ì…)
    const handle = document.createElement('div');
    handle.className = 'rv-resizer';
    wrapper.appendChild(handle);

    const MIN_W = 200, MIN_H = 150;                      // CSSì™€ ë™ì¼ ìµœì†Œê°’
    const MAX_W = Math.min(window.innerWidth  * 0.9, 900);
    const MAX_H = Math.min(window.innerHeight * 0.9, 700);

    function loadSize(){
      try{
        const saved = JSON.parse(localStorage.getItem('rvMiniSize')||'{}');
        if (saved && saved.w && saved.h) {
          wrapper.style.width  = saved.w + 'px';
          wrapper.style.height = saved.h + 'px';
          try { map && map.relayout(); } catch(e){}
        }
      }catch(e){}
    }
    function saveSize(w,h){
      try { localStorage.setItem('rvMiniSize', JSON.stringify({ w:Math.round(w), h:Math.round(h) })); } catch(e){}
    }

    let startX, startY, startW, startH, curW, curH, active=false, rafId=null;

    function onDown(ev){
      ev.preventDefault(); ev.stopPropagation();
      const t = ev.touches ? ev.touches[0] : ev;
      startX = t.clientX; startY = t.clientY;
      const r = wrapper.getBoundingClientRect();
      startW = r.width; startH = r.height;
      active = true;

      document.addEventListener('mousemove', onMove, {passive:false});
      document.addEventListener('mouseup',   onUp,   {passive:false});
      document.addEventListener('touchmove', onMove, {passive:false});
      document.addEventListener('touchend',  onUp,   {passive:false});
    }

    function onMove(ev){
      if (!active) return;
      ev.preventDefault();
      const t = ev.touches ? ev.touches[0] : ev;
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;

      // ì˜¤ë¥¸ìª½ ìœ„ í•¸ë“¤: ì˜¤ë¥¸ìª½(â†’)ìœ¼ë¡œ, ìœ„(â†‘)ë¡œ ë“œë˜ê·¸í• ìˆ˜ë¡ ì»¤ì§
      curW = Math.max(MIN_W, Math.min(startW + dx, MAX_W));
      curH = Math.max(MIN_H, Math.min(startH - dy, MAX_H));

      if (!rafId) rafId = requestAnimationFrame(applySize);
    }

    function applySize(){
      rafId = null;
      if (curW && curH) {
        wrapper.style.width  = curW + 'px';
        wrapper.style.height = curH + 'px';
        try { map && map.relayout(); } catch(e){}
      }
    }

    function onUp(ev){
      if (!active) return;
      ev.preventDefault();
      active = false;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup',   onUp);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend',  onUp);
      if (curW && curH) saveSize(curW, curH);
    }

    handle.addEventListener('mousedown',  onDown, {passive:false});
    handle.addEventListener('touchstart', onDown, {passive:false});

    // ë¡œë“œë·° ì§„ì…/ì¢…ë£Œì— ë”°ë¼ í¬ê¸° ì ìš©/ë³µì›
    const mo = new MutationObserver(() => {
      const rvOn = container.classList.contains('view_roadview');
      if (rvOn) {
        loadSize();
      } else {
        wrapper.style.width  = '100%';
        wrapper.style.height = '100%';
        try { map && map.relayout(); } catch(e){}
      }
    });
    mo.observe(container, { attributes:true, attributeFilter:['class'] });

    if (container.classList.contains('view_roadview')) {
      loadSize();
    }
  })();

});
</script>
</body>
</html>
