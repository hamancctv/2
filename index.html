<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>GIS 모바일</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://hamancctv.github.io/2/favicon.ico" sizes="32x32"/>
  <link rel="stylesheet" href="https://hamancctv.github.io/2/style.css">
  <style>
    /* 검색 UI가 지도 위에 자연스럽게 놓이도록 */
    #mapWrapper { position: relative; }
  </style>
</head>
<body>
  <div id="alert-overlay"><div id="alert-message"></div></div>
  <button id="btnDistance">거리</button>

  <div id="container">
    <div id="rvWrapper">
      <div id="roadview" style="width:100%;height:100%;"></div>
      <div id="close" title="로드뷰닫기" onclick="closeRoadview()"><span class="img"></span></div>
    </div>
    <div id="mapWrapper">
      <div id="map" style="width:100%;height:100%"></div>
      <div id="roadviewControl" onclick="setRoadviewRoad()"></div>
    </div>
  </div>

  <div class="toolbar-right">
    <input type="text" id="gpsyx" class="input-common" inputmode="none"
           value="35.2725308711779, 128.406307024695"/>
    <button id="btn_input_copy" class="btn-common">복사</button>
  </div>

  <div class="custom_typecontrol2_m radius_border">
    <span id="toggle_group" class="btn btn-common">회선</span>
    <span id="btnCurrentMe" class="btn btn-common" onclick="toggleMyLocation()">위치</span>
    <span id="btnTrackMe" class="btn btn-common" onclick="toggleTracking()">추적</span>
  </div>

  <!-- 📌 Kakao 지도 SDK -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services,clusterer,drawing&autoload=false"></script>
  <script src="https://code.jquery.com/jquery-3.6.1.js"></script>

  <!-- 📌 markers-handler.js (마커 & 오버레이) -->
  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>

  <!-- 📌 거리재기 & 회선그리기 -->
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js?v=20250929a"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js?v=20250929a"></script>

  <!-- 📌 검색창/자동완성 (인라인 버전만 사용 → 중복 제거 완료) -->
  <script>
  (function () {
    const CSS = `
    .gx-suggest-search{
      position:absolute; top:8px; left:50%; transform:translateX(-50%);
      display:flex; gap:8px; align-items:center;
      width:min(520px,90vw); z-index:600;
    }
    .gx-suggest-search input{
      flex:1; height:40px; padding:0 12px; border:1px solid #ccc; border-radius:10px;
      background:#fff; font-size:14px; outline:none;
    }
    .gx-suggest-search button{ display:none; }
    .gx-suggest-box{
      position:absolute; top:48px; left:50%; transform:translateX(-50%) translateY(-6px);
      width:min(520px,90vw);
      max-height:40vh; overflow-y:auto;
      border:1px solid #ccc; border-radius:10px;
      background:rgba(255,255,255,0.96);
      box-shadow:0 8px 20px rgba(0,0,0,.15);
      z-index:610;
      opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease;
      display:block;
    }
    .gx-suggest-box.open{ opacity:1; transform:translateX(-50%) translateY(0); pointer-events:auto; }
    .gx-suggest-item{ padding:10px 12px; cursor:pointer; display:flex; align-items:center; gap:8px; }
    .gx-suggest-item:hover, .gx-suggest-item.active{ background:#eef3ff; }
    .gx-suggest-title{ display:inline-block; max-width:60%; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-weight:600; }
    .gx-badge{ font-size:12px; color:#555; background:#f2f4f8; padding:2px 6px; border-radius:6px; }
    .gx-suggest-empty{ color:#777; padding:12px; }
    `;
    const styleEl = document.createElement('style');
    styleEl.textContent = CSS;
    document.head.appendChild(styleEl);

    const CHO = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
    const CHO_SET = new Set(CHO);
    function buildKey(str){
      let out=""; for (const ch of (str||"")){
        const c = ch.charCodeAt(0);
        if (c>=0xAC00 && c<=0xD7A3) out += CHO[Math.floor((c-0xAC00)/588)];
        else if (CHO_SET.has(ch)) out += ch;
        else if (/[0-9]/.test(ch)) out += ch;
        else if (/[A-Z]/.test(ch)) out += ch;
        else if (/[a-z]/.test(ch)) out += ch.toUpperCase();
      }
      return out;
    }
    const esc = s => (s||"").replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    function initSuggestUI(opts){
      const {
        map,
        data = window.SEL_SUGGEST || [],
        parent = document.getElementById('mapWrapper') || document.body,
        getMarkers = () => window.markers || [],
        badges = ['line','encloser','ip'],
        maxItems = 30,
        chooseOnEnter = true,
        openOnFocus = true
      } = opts || {};

      const wrap = document.createElement('div');
      wrap.className = 'gx-suggest-search';
      wrap.innerHTML = `
        <input type="search" class="gx-input" placeholder="예) ㅎㅇㄱㅂㄱㅅ, ㄷ032, 시설명…" autocomplete="off" />
        <button type="button" class="gx-btn">검색</button>
      `;
      const box = document.createElement('div');
      box.className = 'gx-suggest-box';
      parent.appendChild(wrap); parent.appendChild(box);

      const kw = wrap.querySelector('.gx-input');
      const RAW = (data||[]).filter(it => it && (it.name||it.addr||it.ip)).map((it,idx)=>({
        id: it.id || `s_${idx}`,
        name: it.name || "",
        line: it.line || "",
        encloser: it.encloser || "",
        addr: it.addr || "",
        lat: it.lat, lng: it.lng,
        ip: it.ip || ""
      }));
      RAW.forEach(it=>{
        it.key = buildKey([it.name,it.line,it.encloser,it.ip].filter(Boolean).join(" "));
        it.nameLen = (it.name||"").length;
      });
      const IDMAP = Object.fromEntries(RAW.map(it => [it.id,it]));

      function match(q){
        const k=buildKey(q); if(!k) return [];
        const res=[];
        for(const it of RAW){ if(it.key.indexOf(k)!==-1) res.push(it); if(res.length>=2000) break; }
        res.sort((a,b)=>{
          const ai=a.key.indexOf(k), bi=b.key.indexOf(k);
          if(ai!==bi) return ai-bi;
          if(a.nameLen!==b.nameLen) return a.nameLen-b.nameLen;
          return a.id.localeCompare(b.id);
        });
        return res.slice(0,maxItems);
      }
      function render(items){
        if(!items.length){ box.innerHTML=`<div class="gx-suggest-empty">검색 결과 없음</div>`; return; }
        box.innerHTML = items.map(it=>{
          const title=esc(it.name);
          const badgeHtml = badges.map(b=>{
            const v=it[b]; return v?`<span class="gx-badge">${esc(String(v))}</span>`:'';
          }).join('');
          return `<div class="gx-suggest-item" data-id="${it.id}">
            <span class="gx-suggest-title">${title}</span>${badgeHtml}
          </div>`;
        }).join('');
      }
      const openBox=()=>box.classList.add('open');
      const closeBox=()=>{ box.classList.remove('open'); setActive(-1); };

      let active=-1, rafId=null;
      function setActive(i){
        const items=box.querySelectorAll('.gx-suggest-item');
        items.forEach((el,idx)=>el.classList.toggle('active', idx===i));
        active=i;
        if(i>=0&&items[i]) items[i].scrollIntoView({block:'nearest'});
      }
      function schedule(q){
        if(rafId) cancelAnimationFrame(rafId);
        rafId=requestAnimationFrame(()=>{
          rafId=null;
          const items=match(q);
          if(items.length){ render(items); openBox(); setActive(-1); }
          else closeBox();
        });
      }
      function applySelection(item){
        if(!item) return;
        kw.value=item.name;
        const markers=getMarkers()||[];
        const found=markers.find(m=>{
          const p=m.getPosition?.(); if(!p) return false;
          return Math.abs(p.getLat()-item.lat)<1e-9 && Math.abs(p.getLng()-item.lng)<1e-9;
        });
        if(found && window.kakao && window.kakao.maps){
          kakao.maps.event.trigger(found,"mousedown");
          setTimeout(()=>kakao.maps.event.trigger(found,"mouseup"),0);
          map.panTo(found.getPosition());
        } else if(Number.isFinite(item.lat)&&Number.isFinite(item.lng)){
          map.panTo(new kakao.maps.LatLng(item.lat,item.lng));
        }
        closeBox();
      }

      kw.addEventListener('compositionupdate', ()=>{ const v=kw.value.trim(); if(!v){closeBox();return;} schedule(v); });
      kw.addEventListener('input', ()=>{ const v=kw.value.trim(); if(!v){closeBox();return;} schedule(v); });
      kw.addEventListener('keydown', e=>{
        const visible=box.classList.contains('open');
        if(visible){
          const items=box.querySelectorAll('.gx-suggest-item');
          if(e.key==='ArrowDown'){ e.preventDefault(); setActive(active<items.length-1?active+1:0); }
          else if(e.key==='ArrowUp'){ e.preventDefault(); setActive(active>0?active-1:items.length-1); }
          else if(e.key==='Enter'){ e.preventDefault(); const list=match(kw.value); if(list.length){ applySelection(active>=0?list[active]:list[0]); } else closeBox(); }
          else if(e.key==='Escape'){ closeBox(); }
        } else if(e.key==='Enter'){
          e.preventDefault(); const list=match(kw.value); if(list.length) applySelection(list[0]);
        }
      });

      box.addEventListener('mousedown', e=>{
        const el=e.target.closest('.gx-suggest-item'); if(!el) return;
        applySelection(IDMAP[el.dataset.id]); e.preventDefault();
      });
      if(openOnFocus){
        kw.addEventListener('focus', ()=>{ const v=kw.value.trim(); if(v) schedule(v); });
      }
      document.addEventListener('click', (e)=>{
        const within=e.target.closest('.gx-suggest-search')||e.target.closest('.gx-suggest-box');
        if(!within) closeBox();
      });

      return { setData(newData){ RAW.length=0; (newData||[]).forEach((it,idx)=>{ const row={ id:it.id||`s_${idx}`, name:it.name||"", line:it.line||"", encloser:it.encloser||"", addr:it.addr||"", lat:it.lat, lng:it.lng, ip:it.ip||"" }; row.key=buildKey([row.name,row.line,row.encloser,row.ip].filter(Boolean).join(" ")); row.nameLen=(row.name||"").length; RAW.push(row); }); Object.keys(IDMAP).forEach(k=>delete IDMAP[k]); RAW.forEach(it=>IDMAP[it.id]=it); } };
    }
    window.initSuggestUI=initSuggestUI;
  })();
  </script>

  <!-- 📌 앱 초기화 -->
  <script>
  kakao.maps.load(function () {
    const mapCenter = new kakao.maps.LatLng(35.2725308711779, 128.406307024695);
    const map = new kakao.maps.Map(document.getElementById('map'), { center: mapCenter, level: 4 });
    map.setMaxLevel(9);
    window.map = map;

    // === (로드뷰/내 위치/추적/거리재기/회선토글) 기존 로직 그대로 ===
    // ... [생략: 기존과 동일] ...

    // ===== 마커 생성 =====
    const positions = (window.SEL_SUGGEST || [])
      .map(it => {
        const lat=parseFloat(it.lat), lng=parseFloat(it.lng);
        if(!isFinite(lat)||!isFinite(lng)) return null;
        return { latlng:new kakao.maps.LatLng(lat,lng), content:it.name, group:it.line||null };
      }).filter(Boolean);

    const unique={}, filtered=[];
    for(const p of positions){
      const key=p.latlng.getLat()+","+p.latlng.getLng();
      if(!unique[key]){ unique[key]=true; filtered.push(p); }
    }
    if(window.initMarkers) initMarkers(map, filtered);

    // ===== 검색창 붙이기 =====
    if(window.initSuggestUI){
      initSuggestUI({
        map,
        data: window.SEL_SUGGEST,
        parent: document.getElementById('mapWrapper'),
        getMarkers: ()=>window.markers,
        badges:['line','encloser','ip'],
        maxItems:30,
        chooseOnEnter:true,
        openOnFocus:true
      });
    }
  });
  </script>
</body>
</html>
