<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>GIS 라이트</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

<!-- Kakao Maps SDK (services + 수동 로드) -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>

<!-- 기존 스타일 -->
<link rel="stylesheet" href="https://hamancctv.github.io/2/style.css" />

<style>
  html, body { height:100%; margin:0; }
  #container { position:relative; height:100%; overflow:hidden; }
  #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
  #map { width:100%; height:100%; }

  /* 로드뷰 전체화면(지도는 미니맵) */
  #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
  #roadview  { width:100%; height:100%; }
  .view_roadview #rvWrapper { display:block; z-index:1; }
  .view_roadview #mapWrapper {
    position:absolute; left:8px; bottom:8px;
    width:26%; height:26%;
    min-width:200px; min-height:150px;
    border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }

  /* 로드뷰 닫기 */
  #close {
    position:absolute; top:8px; left:8px;
    padding:6px; background:#fff; border:1px solid #c8c8c8; border-radius:6px;
    cursor:pointer; z-index:3; box-shadow:0 1px #888;
  }
  #close .img {
    display:block; width:14px; height:14px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/rv_close.png) no-repeat;
  }

  /* 좌측 툴바 */
  .toolbar { position:absolute; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:620; }

  /* 위성뷰 버튼(40×40) */
  .btn-satellite {
    width:40px; height:40px;
    display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #ccc; border-radius:8px; background:#fff; color:#555;
    cursor:pointer; transition:all .2s ease; box-sizing:border-box;
  }
  .btn-satellite:hover { box-shadow:0 3px 12px rgba(0,0,0,.12); }
  .btn-satellite.selected { border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff; }
  .btn-satellite svg { width:18px; height:18px; display:block; }
  .btn-satellite svg circle { fill:currentColor; }

  /* 로드뷰 버튼(40×40, CSS 아이콘) */
  #roadviewControl{
    width:40px; height:40px;
    display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer;
    border:1px solid #ccc; border-radius:8px; background:#fff !important;
    background-image:none !important;
    color:#555; transition:all .2s ease; box-sizing:border-box;
  }
  #roadviewControl:hover{ box-shadow:0 3px 12px rgba(0,0,0,.12); }
  #roadviewControl.active{
    border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff;
  }
  #roadviewControl::before{
    content:"";
    width:18px; height:18px; border-radius:50%;
    display:block;
    background: radial-gradient(#fff 0 28%, currentColor 29% 100%);
  }

  /* 미니맵 크기조절 핸들 (↗ 드래그: 위/오른쪽으로 끌수록 커짐) */
  #mapWrapper .rv-resizer{
    position:absolute; right:6px; top:6px;
    width:16px; height:16px;
    border:1px solid #bbb; border-radius:4px; background:#fff;
    box-shadow:0 1px 3px rgba(0,0,0,.2);
    cursor: nesw-resize;
    z-index:650; display:none;
  }
  #mapWrapper .rv-resizer::before{
    content:""; position:absolute; inset:2px;
    background: linear-gradient(135deg, transparent 50%, #888 0) no-repeat;
    opacity:.7;
  }
  .view_roadview #mapWrapper .rv-resizer{ display:block; }

  /* === MapWalker (노란 웨지 + 회전) === */
  .MapWalker {position:absolute; margin:-26px 0 0 -51px; cursor:grab; }
  .MapWalker.dragging{ cursor:grabbing; }
  .MapWalker.pick { outline:2px solid rgba(255,215,0,.7); border-radius:6px; }

  .MapWalker .figure {
    position:absolute; width:25px; left:38px; top:-2px; height:39px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png) -298px -114px no-repeat;
    pointer-events:none;
  }

  /* 노란 웨지: 베이스(고정) + 프런트(회전) — 스프라이트를 마스크로 사용 */
  .MapWalker .angleBase,
  .MapWalker .angleFront{
    position:absolute; left:0; top:0; width:102px; height:52px;
    background:#FFD400;           /* ← 정확한 노란색 */
    -webkit-mask-image:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png);
            mask-image:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png);
    -webkit-mask-repeat:no-repeat; mask-repeat:no-repeat;
  }
  /* 베이스는 항상 같은 프레임(배경 웨지 느낌) */
  .MapWalker .angleBase{
    opacity:.35;
    -webkit-mask-position:-834px -2px; mask-position:-834px -2px;
  }

  /* 회전 프레임(프런트만 움직임) */
  .MapWalker.m0  .angleFront{ -webkit-mask-position:-834px  -2px; mask-position:-834px  -2px; opacity:.9; }
  .MapWalker.m1  .angleFront{ -webkit-mask-position:-938px  -2px; mask-position:-938px  -2px; opacity:.9; }
  .MapWalker.m2  .angleFront{ -webkit-mask-position:-1042px -2px; mask-position:-1042px -2px; opacity:.9; }
  .MapWalker.m3  .angleFront{ -webkit-mask-position:-1146px -2px; mask-position:-1146px -2px; opacity:.9; }
  .MapWalker.m4  .angleFront{ -webkit-mask-position:-1250px -2px; mask-position:-1250px -2px; opacity:.9; }
  .MapWalker.m5  .angleFront{ -webkit-mask-position:-1354px -2px; mask-position:-1354px -2px; opacity:.9; }
  .MapWalker.m6  .angleFront{ -webkit-mask-position:-1458px -2px; mask-position:-1458px -2px; opacity:.9; }
  .MapWalker.m7  .angleFront{ -webkit-mask-position:-1562px -2px; mask-position:-1562px -2px; opacity:.9; }
  .MapWalker.m8  .angleFront{ -webkit-mask-position:-2px    -2px; mask-position:-2px    -2px; opacity:.9; }
  .MapWalker.m9  .angleFront{ -webkit-mask-position:-106px  -2px; mask-position:-106px  -2px; opacity:.9; }
  .MapWalker.m10 .angleFront{ -webkit-mask-position:-210px  -2px; mask-position:-210px  -2px; opacity:.9; }
  .MapWalker.m11 .angleFront{ -webkit-mask-position:-314px  -2px; mask-position:-314px  -2px; opacity:.9; }
  .MapWalker.m12 .angleFront{ -webkit-mask-position:-418px  -2px; mask-position:-418px  -2px; opacity:.9; }
  .MapWalker.m13 .angleFront{ -webkit-mask-position:-522px  -2px; mask-position:-522px  -2px; opacity:.9; }
  .MapWalker.m14 .angleFront{ -webkit-mask-position:-626px  -2px; mask-position:-626px  -2px; opacity:.9; }
  .MapWalker.m15 .angleFront{ -webkit-mask-position:-730px  -2px; mask-position:-730px  -2px; opacity:.9; }

  /* figure 방향 프레임 */
  .MapWalker.m0  .figure{background-position:-298px -114px;}
  .MapWalker.m1  .figure{background-position:-335px -114px;}
  .MapWalker.m2  .figure{background-position:-372px -114px;}
  .MapWalker.m3  .figure{background-position:-409px -114px;}
  .MapWalker.m4  .figure{background-position:-446px -114px;}
  .MapWalker.m5  .figure{background-position:-483px -114px;}
  .MapWalker.m6  .figure{background-position:-520px -114px;}
  .MapWalker.m7  .figure{background-position:-557px -114px;}
  .MapWalker.m8  .figure{background-position:-2px   -114px;}
  .MapWalker.m9  .figure{background-position:-39px  -114px;}
  .MapWalker.m10 .figure{background-position:-76px  -114px;}
  .MapWalker.m11 .figure{background-position:-113px -114px;}
  .MapWalker.m12 .figure{background-position:-150px -114px;}
  .MapWalker.m13 .figure{background-position:-187px -114px;}
  .MapWalker.m14 .figure{background-position:-224px -114px;}
  .MapWalker.m15 .figure{background-position:-261px -114px;}
</style>
</head>
<body>
  <div id="container">
    <!-- 지도 -->
    <div id="mapWrapper">
      <div id="map"></div>

      <!-- 좌측 툴바 -->
      <div class="toolbar">
        <button id="btnSatellite" class="btn-satellite" title="위성뷰">
          <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"/></svg>
        </button>
        <button id="roadviewControl" title="로드뷰"></button>
      </div>

      <!-- 미니맵 리사이저 핸들 -->
      <div class="rv-resizer" aria-hidden="true"></div>
    </div> <!-- mapWrapper 닫기 -->

    <!-- 로드뷰(전체화면) -->
    <div id="rvWrapper">
      <div id="roadview"></div>
      <div id="close" title="로드뷰 닫기"><span class="img"></span></div>
    </div>
  </div>

  <!-- 기존 스크립트들 -->
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js"></script>
  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>
  <script src="https://hamancctv.github.io/2/search-suggest.js"></script>

<script>
/* 짧은 헬퍼 */
const $  = s => document.querySelector(s);

/* 전역 */
let map, geocoder, places;
let overlayOn = false, rv, rvClient;
let mapWalker = null;   // 클릭/드래그 가능 동동이
let pickMode  = false;  // 동동이 클릭 후 지도 클릭으로 옮기기

/* MapWalker: 노란 웨지 + 클릭/드래그 */
function MapWalker(position){
  const content   = document.createElement('div');
  const angleBase = document.createElement('div');  // 고정 웨지(연한 노랑)
  const angleFront= document.createElement('div');  // 회전 웨지(진한 노랑)
  const figure    = document.createElement('div');

  content.className   = 'MapWalker';
  angleBase.className = 'angleBase';
  angleFront.className= 'angleFront';
  figure.className    = 'figure';

  content.appendChild(angleBase);
  content.appendChild(angleFront);
  content.appendChild(figure);

  const walker = new kakao.maps.CustomOverlay({
    position, content, yAnchor: 1, clickable: true
  });
  walker.setZIndex(99999);  // ✅ 마커보다 항상 위

  this.walker   = walker;
  this.content  = content;
  this.position = position;

  // ---- 드래그 (마우스/터치) ----
  const self = this;
  let dragging = false, startX=0, startY=0, startPt=null, moved=false;

  function onDown(ev){
    if (!overlayOn) return;
    if (ev.touches && ev.touches.length > 1) return;
    ev.preventDefault();
    content.classList.add('dragging');
    dragging = true; moved = false;
    const t = ev.touches ? ev.touches[0] : ev;
    startX = t.clientX; startY = t.clientY;

    const proj = map.getProjection();
    startPt = proj.containerPointFromCoords(self.position);

    map.setDraggable(false);
    map.setZoomable(false);

    document.addEventListener('mousemove', onMove, {passive:false});
    document.addEventListener('mouseup',   onUp,   {passive:false});
    document.addEventListener('touchmove', onMove, {passive:false});
    document.addEventListener('touchend',  onUp,   {passive:false});
  }
  function onMove(ev){
    if (!dragging) return;
    if (ev.touches && ev.touches.length > 1) return;
    ev.preventDefault();
    const t = ev.touches ? ev.touches[0] : ev;
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    if (Math.abs(dx) + Math.abs(dy) > 3) moved = true;

    const proj = map.getProjection();
    const newPt = new kakao.maps.Point(startPt.x + dx, startPt.y + dy);
    const newPos = proj.coordsFromContainerPoint(newPt);
    self.setPosition(newPos);
  }
  function onUp(ev){
    if (!dragging) return;
    ev.preventDefault();
    dragging = false;
    content.classList.remove('dragging');

    map.setDraggable(true);
    map.setZoomable(true);

    if (moved) {
      try { setRoadviewAt(self.position); } catch(e) {}
    } else {
      // 클릭만 했다면: 이동 모드 토글
      pickMode = !pickMode;
      if (pickMode) { content.classList.add('pick'); flash('이동할 위치를 지도에서 클릭하세요'); }
      else          { content.classList.remove('pick'); flash('이동 취소'); }
    }

    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup',   onUp);
    document.removeEventListener('touchmove', onMove);
    document.removeEventListener('touchend',  onUp);
  }

  content.addEventListener('mousedown',  onDown, {passive:false});
  content.addEventListener('touchstart', onDown, {passive:false});
}
MapWalker.prototype.setAngle = function(angle){
  const a = ((angle % 360) + 360) % 360;
  const idx = Math.floor(((a + 11.25) % 360) / 22.5); // 0..15
  // pick 클래스 유지
  this.content.className = 'MapWalker
