<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>GIS 라이트</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>
<link rel="stylesheet" href="https://hamancctv.github.io/2/style.css" />
<style>
  html, body { height:100%; margin:0; }
  #container { position:relative; height:100%; overflow:hidden; }
  #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
  #map { width:100%; height:100%; }

  /* ✅ 로드뷰/지도 분할 및 z-index 수정 */
  #rvWrapper { position:absolute; inset:0; display:none; z-index:0; } /* ⬅ z-index 0으로 수정 */
  #roadview  { width:100%; height:100%; }
  .view_roadview #rvWrapper { display:block; z-index:0; } /* ⬅ 로드뷰가 map 아래로 */
  .view_roadview #mapWrapper {
    position:absolute; left:8px; bottom:8px;
    width:26%; height:26%;
    min-width:200px; min-height:150px;
    border:2px solid #ccc; border-radius:8px; background:#fff; z-index:3; /* ⬅ z-index 3으로 상승 */
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }

  #close {
    position:absolute; top:8px; left:8px;
    padding:6px; background:#fff; border:1px solid #c8c8c8; border-radius:6px;
    cursor:pointer; z-index:4; box-shadow:0 1px #888;
  }
  #close .img {
    display:block; width:14px; height:14px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/rv_close.png) no-repeat;
  }

  .toolbar { position:fixed; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:10; }
  .btn-satellite {
    width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #ccc; border-radius:8px; background:#fff; color:#555;
    cursor:pointer; transition:all .2s ease; box-sizing:border-box;
  }
  .btn-satellite:hover { box-shadow:0 3px 12px rgba(0,0,0,.12); }
  .btn-satellite.selected { border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff; }
  .btn-satellite svg { width:18px; height:18px; display:block; }
  .btn-satellite svg circle { fill:currentColor; }

  #roadviewControl{
    width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#fff !important;
    color:#555; transition:all .2s ease; box-sizing:border-box;
  }
  #roadviewControl:hover{ box-shadow:0 3px 12px rgba(0,0,0,.12); }
  #roadviewControl.active{
    border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff;
  }
  #roadviewControl::before{
    content:""; width:18px; height:18px; border-radius:50%;
    display:block; background: radial-gradient(#fff 0 28%, currentColor 29% 100%);
  }

  /* ✅ 리사이저 클릭 차단 */
  #mapWrapper .rv-resizer{
    position:absolute; right:6px; top:6px;
    width:16px; height:16px; border:1px solid #bbb; border-radius:4px; background:#fff;
    box-shadow:0 1px 3px rgba(0,0,0,.2); z-index:650;
    cursor: nesw-resize;
    pointer-events:none; /* ✅ 클릭 막지 않게 */
  }
  #mapWrapper .rv-resizer::before{
    content:""; position:absolute; inset:2px;
    background: linear-gradient(135deg, transparent 50%, #888 0) no-repeat; opacity:.7;
  }
  .view_roadview #mapWrapper .rv-resizer{ display:block; }

  .MapWalker {position:absolute; margin:-26px 0 0 -51px; cursor:grab; z-index:2147483647;}
  .MapWalker.dragging{ cursor:grabbing; }
  .MapWalker .figure {
    position:absolute; width:25px; left:38px; top:-2px; height:39px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png) -298px -114px no-repeat;
    pointer-events:none;
  }
  .MapWalker .angleBase,.MapWalker .angleFront{
    position:absolute; left:0; top:0; width:102px; height:52px;
    background-image:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png);
    background-repeat:no-repeat;
    filter: sepia(1) saturate(5.5) hue-rotate(8deg) brightness(1.12) contrast(0.98);
  }
  .MapWalker .angleBase{ background-position:-834px -2px; opacity:.18; }
  .MapWalker .angleFront{ opacity:.92; }
</style>
</head>
<body>
  <div id="container">
    <div id="mapWrapper">
      <div id="map"></div>
      <div class="toolbar">
        <button id="btnSatellite" class="btn-satellite" title="위성뷰">
          <svg viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="9"/></svg>
        </button>
        <button id="roadviewControl" title="로드뷰"></button>
      </div>
      <div class="rv-resizer" aria-hidden="true"></div>
    </div>
    <div id="rvWrapper"><div id="roadview"></div></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>

  <!-- 인터랙션 잠금 제어 -->
  <script>
  window.__interactionLock=false;
  window.isInteractionLocked=()=>window.__interactionLock===true;
  window.setInteractionLock=(s)=>{window.__interactionLock=!!s;console.log(`[interactionLock] ${s?"LOCKED":"UNLOCKED"}`);}
  </script>

  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>
  <script src="https://hamancctv.github.io/2/search-suggest.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js"></script>

<script>
/* ======== 초기화 ======== */
kakao.maps.load(function(){
  const center=new kakao.maps.LatLng(35.2725308711779,128.406307024695);
  map=new kakao.maps.Map(document.getElementById('map'),{center,level:4});
  map.setMaxLevel(9);
  geocoder=new kakao.maps.services.Geocoder();
  places=new kakao.maps.services.Places();
  rvClient=new kakao.maps.RoadviewClient();
  rv=new kakao.maps.Roadview(document.getElementById('roadview'));

  /* ✅ 동동이 중앙 유지 기능 */
  function smoothWalkerCenter(duration=400){
    if(!overlayOn||!mapWalker)return;
    try{
      const pos=rv.getPosition();
      const start=mapWalker.position;
      const startLat=start.getLat(),startLng=start.getLng();
      const endLat=pos.getLat(),endLng=pos.getLng();
      const startTime=performance.now();
      function animate(){
        const now=performance.now();
        const t=Math.min(1,(now-startTime)/duration);
        const eased=t<0.5?2*t*t:-1+(4-2*t)*t;
        const lat=startLat+(endLat-startLat)*eased;
        const lng=startLng+(endLng-startLng)*eased;
        const interp=new kakao.maps.LatLng(lat,lng);
        mapWalker.setPosition(interp);
        map.setCenter(interp);
        if(t<1)requestAnimationFrame(animate);
      }
      requestAnimationFrame(animate);
    }catch(e){}
  }
  kakao.maps.event.addListener(rv,'init',()=>smoothWalkerCenter(400));
  kakao.maps.event.addListener(rv,'viewpoint_changed',()=>smoothWalkerCenter(300));
  kakao.maps.event.addListener(rv,'position_changed',()=>smoothWalkerCenter(300));
  window.addEventListener("resize",()=>{
    if(!rv||!rvClient)return;
    const pos=rv.getPosition();
    rvClient.getNearestPanoId(pos,50,(id)=>{
      if(id){rv.setPanoId(id,pos);smoothWalkerCenter(500);}
    });
  });
  (function(){
    const c=document.getElementById('container');
    const w=document.getElementById('mapWrapper');
    const h=w.querySelector('.rv-resizer');
    if(!h)return;
    const obs=new MutationObserver(()=>{if(c.classList.contains('view_roadview'))smoothWalkerCenter(400);});
    obs.observe(c,{attributes:true,attributeFilter:['class']});
    let to=null;
    ['mouseup','touchend'].forEach(evt=>{
      h.addEventListener(evt,()=>{
        if(overlayOn){clearTimeout(to);to=setTimeout(()=>smoothWalkerCenter(400),100);}
      });
    });
  })();

  /* ===== 이하 기존 로드뷰·버튼·검색 등 전체 로직 그대로 ===== */
});
</script>
</body>
</html>
