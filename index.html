<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>GIS 라이트</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

<!-- Kakao Maps SDK (services + 수동 로드) -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>

<link rel="stylesheet" href="https://hamancctv.github.io/2/style.css" />

<style>
  html, body { height:100%; margin:0; }
  #container { position:relative; height:100%; overflow:hidden; }
  #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
  #map { width:100%; height:100%; }

  /* 로드뷰 전체화면(지도는 미니맵) */
  #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
  #roadview  { width:100%; height:100%; }
  .view_roadview #rvWrapper { display:block; z-index:1; }
  .view_roadview #mapWrapper {
    position:absolute; left:8px; bottom:8px;
    width:26%; height:26%;
    min-width:200px; min-height:150px;
    border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }

  /* 로드뷰 닫기 버튼 */
  #close {
    position:absolute; top:8px; left:8px;
    padding:6px; background:#fff; border:1px solid #c8c8c8; border-radius:6px;
    cursor:pointer; z-index:3; box-shadow:0 1px #888;
  }
  #close .img {
    display:block; width:14px; height:14px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/rv_close.png) no-repeat;
  }

  /* 좌측 툴바 */
  .toolbar { position:fixed; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:10; }

  .btn-satellite {
    width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
    border:1px solid #ccc; border-radius:8px; background:#fff; color:#555;
    cursor:pointer; transition:all .2s ease; box-sizing:border-box;
  }
  .btn-satellite:hover { box-shadow:0 3px 12px rgba(0,0,0,.12); }
  .btn-satellite.selected { border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff; }
  .btn-satellite svg { width:18px; height:18px; display:block; }
  .btn-satellite svg circle { fill:currentColor; }

  /* 로드뷰 버튼 */
  #roadviewControl{
    width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
    cursor:pointer; border:1px solid #ccc; border-radius:8px; background:#fff !important;
    background-image:none !important; color:#555; transition:all .2s ease; box-sizing:border-box;
  }
  #roadviewControl:hover{ box-shadow:0 3px 12px rgba(0,0,0,.12); }
  #roadviewControl.active{
    border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff;
  }
  #roadviewControl::before{
    content:""; width:18px; height:18px; border-radius:50%;
    display:block; background: radial-gradient(#fff 0 28%, currentColor 29% 100%);
  }

  /* 미니맵 크기조절 핸들 */
  #mapWrapper .rv-resizer{
    position:absolute; right:6px; top:6px; width:16px; height:16px;
    border:1px solid #bbb; border-radius:4px; background:#fff;
    box-shadow:0 1px 3px rgba(0,0,0,.2);
    cursor: nesw-resize; z-index:650; display:none;
  }
  #mapWrapper .rv-resizer::before{
    content:""; position:absolute; inset:2px;
    background: linear-gradient(135deg, transparent 50%, #888 0) no-repeat; opacity:.7;
  }
  .view_roadview #mapWrapper .rv-resizer{ display:block; }

  /* === (중요) RV 모드에서 외부 오버레이 포인터 차단 === */
  .view_roadview #mapWrapper * { -webkit-tap-highlight-color:transparent; }
  .view_roadview #mapWrapper .MapWalker   { pointer-events:auto !important; z-index:2147483647 !important; }
  .view_roadview #mapWrapper .rv-resizer  { pointer-events:auto !important; z-index:2147483646 !important; }

  .view_roadview #mapWrapper .infoWindow,
  .view_roadview #mapWrapper .overlay,
  .view_roadview #mapWrapper .customoverlay,
  .view_roadview #mapWrapper [class*="overlay"],
  .view_roadview #mapWrapper [class*="Overlay"],
  .view_roadview #mapWrapper [class*="marker"],
  .view_roadview #mapWrapper [class*="Marker"] { pointer-events:none !important; }

  /* === MapWalker === */
  .MapWalker {position:absolute; margin:-26px 0 0 -51px; cursor:grab; z-index:2147483647;}
  .MapWalker.dragging{ cursor:grabbing; }
  .MapWalker.pick { outline:2px solid rgba(255,215,0,.7); border-radius:6px; }

  .MapWalker .figure {
    position:absolute; width:25px; left:38px; top:-2px; height:39px;
    background:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png) -298px -114px no-repeat;
    pointer-events:none;
  }
</style>
</head>
<body>
  <div id="container">
    <div id="mapWrapper">
      <div id="map"></div>
      <div class="toolbar">
        <button id="btnSatellite" class="btn-satellite" title="위성뷰">
          <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>
        </button>
        <button id="roadviewControl" title="로드뷰"></button>
      </div>
      <div class="rv-resizer"></div>
    </div>

    <div id="rvWrapper"><div id="roadview"></div></div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>

  <!-- ✅ 인터랙션 잠금 전역 -->
  <script>
  window.__interactionLock = false;
  window.__interactionLockStyle = null;
  window.isInteractionLocked = ()=> window.__interactionLock === true;
  window.setInteractionLock = function(state){
    window.__interactionLock = !!state;
    console.log(`[interactionLock] ${state ? "LOCKED" : "UNLOCKED"}`);
    if(state){
      if(!window.__interactionLockStyle){
        const st=document.createElement("style");
        st.id="interaction-lock-style";
        st.textContent=`
          .overlay-hover, .overlay-click, .customoverlay, [class*="marker"], [class*="Marker"] {
            pointer-events:none !important;
            cursor:default !important;
          }`;
        document.head.appendChild(st);
        window.__interactionLockStyle=st;
      }
    }else{
      if(window.__interactionLockStyle){
        window.__interactionLockStyle.remove();
        window.__interactionLockStyle=null;
      }
    }
  };
  </script>

  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>
  <script src="https://hamancctv.github.io/2/search-suggest.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js"></script>

  <script>
  /* =====================================================
     지도 초기화 및 로드뷰 / 거리재기 완전 통합 제어
  ====================================================== */
  const $ = s => document.querySelector(s);
  let map, geocoder, places, overlayOn=false, rv, rvClient;
  let mapWalker=null, pickMode=false;

  // === 로드뷰 오버레이 토글 (기존 기능 그대로) ===
  function toggleOverlay(active){
    const btn=$("#roadviewControl");
    if(active){
      overlayOn=true; btn.classList.add("active");
      map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
      setAllOverlaysZForRV(true);
      setAllOverlaysClickForRV(true);
      if(!mapWalker){mapWalker=new MapWalker(map.getCenter()); mapWalker.setMap(map);}
      else{mapWalker.setPosition(map.getCenter()); mapWalker.setMap(map);}
      setRoadviewAt(map.getCenter());
    }else{
      overlayOn=false; pickMode=false; btn.classList.remove("active");
      map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
      setAllOverlaysClickForRV(false); setAllOverlaysZForRV(false);
      if(mapWalker){mapWalker.content.classList.remove("pick"); mapWalker.setMap(null);}
      $("#container").classList.remove("view_roadview"); map.relayout();
    }
  }

  // ✅ 인터랙션 잠금 통합
  function toggleRoadview(){
    if(!overlayOn){
      setInteractionLock(true);
      toggleOverlay(true);
    }else{
      setInteractionLock(false);
      toggleOverlay(false);
    }
  }

  kakao.maps.load(()=>{
    const center=new kakao.maps.LatLng(35.2725308711779,128.406307024695);
    map=new kakao.maps.Map($("#map"),{center,level:4});
    map.setMaxLevel(9);
    geocoder=new kakao.maps.services.Geocoder();
    places=new kakao.maps.services.Places();
    rvClient=new kakao.maps.RoadviewClient();
    rv=new kakao.maps.Roadview($("#roadview"));

    patchOverlayZTracking(); patchZIndexSetter(); patchEventCapture();

    kakao.maps.event.addListener(rv,'viewpoint_changed',()=>{if(overlayOn&&mapWalker){const vp=rv.getViewpoint();mapWalker.setAngle(vp.pan);}});
    kakao.maps.event.addListener(rv,'position_changed',()=>{if(overlayOn){const pos=rv.getPosition();map.setCenter(pos);if(mapWalker)mapWalker.setPosition(pos);}});
    kakao.maps.event.addListener(map,'click',e=>{if(!overlayOn)return;const pos=e.latLng;if(pickMode&&mapWalker){mapWalker.setPosition(pos);mapWalker.content.classList.remove('pick');pickMode=false;}setRoadviewAt(pos);});

    $("#roadviewControl").addEventListener("click",toggleRoadview);

    const btnSat=$("#btnSatellite");
    btnSat.addEventListener("click",()=>{
      if(map.getMapTypeId()===kakao.maps.MapTypeId.ROADMAP){
        map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);
        btnSat.classList.add("selected");
      }else{
        map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);
        btnSat.classList.remove("selected");
      }
    });

    if(window.SEL_SUGGEST&&typeof initMarkers==="function"){
      const unique=new Map();const positionsLike=[];
      for(const it of window.SEL_SUGGEST){
        const lat=parseFloat(it.lat),lng=parseFloat(it.lng);
        if(!isFinite(lat)||!isFinite(lng))continue;
        const key=lat+","+lng;if(unique.has(key))continue;
        unique.set(key,true);
        positionsLike.push({latlng:new kakao.maps.LatLng(lat,lng),content:it.name1||it.name||'',searchName:it.name2||it.name||'',group:it.group||null,__lat:lat,__lng:lng});
      }
      initMarkers(map,positionsLike);
    }
    if(typeof initSuggestUI==="function"){
      initSuggestUI({map,data:window.SEL_SUGGEST||[],parent:$("#mapWrapper"),getMarkers:()=>window.markers,badges:['line','enclosure','address','ip','group'],maxItems:30,chooseOnEnter:true,openOnFocus:true});
    }
  });
  </script>
</body>
</html>
