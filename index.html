<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>CCTV GIS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <!-- Kakao Maps (deferred, autoload=false) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>

  <!-- 프로젝트 공용 스타일 -->
  <link rel="stylesheet" href="style.css"/>

  <!-- 최소 보조 스타일(필요한 것만) -->
  <style>
    html, body { height:100%; margin:0; }
    #container { position:relative; height:100%; overflow:hidden; display:none; }
    #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
    #map { width:100%; height:100%; cursor:grab; }
    #map:active { cursor:grabbing; }

    /* 툴바 */
    .toolbar {
      position:fixed; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:10;
    }
    .toolbar button {
      width:42px; height:42px; display:flex; align-items:center; justify-content:center;
      font-size:22px; border:1px solid #ccc; border-radius:10px;
      background:linear-gradient(180deg,#fff 0%,#f8f8f8 100%); color:#333;
      cursor:pointer; transition:.25s; box-shadow:0 2px 5px rgba(0,0,0,.1);
    }
    .toolbar button:hover { transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,.18); }
    .toolbar button.active {
      border-color:#007aff; color:#007aff;
      background:linear-gradient(180deg,#eaf3ff 0%,#d7e9ff 100%);
      box-shadow:0 0 0 3px rgba(0,122,255,.15) inset, 0 3px 10px rgba(0,0,0,.12);
      transform:translateY(1px);
    }

    /* 로드뷰 영역(초기 비표시) */
    #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
    #roadview  { width:100%; height:100%; }
    .view_roadview #rvWrapper { display:block; z-index:1; }
    .view_roadview #mapWrapper {
      position:absolute; left:8px; bottom:8px; width:26%; height:26%; min-width:200px; min-height:150px;
      border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2; box-shadow:0 8px 24px rgba(0,0,0,.2);
    }
    /* 미니맵 리사이저(로드뷰일 때만 노출) */
    #mapWrapper .rv-resizer {
      position:absolute; right:0; top:0; width:20px; height:20px;
      background:linear-gradient(225deg,#f4f4f4 0%,#f4f4f4 49.9%, transparent 50%);
      cursor:nesw-resize; opacity:.75; display:none; z-index:9999;
    }
    .view_roadview #mapWrapper .rv-resizer { display:block; }

    /* 로그인 오버레이 */
    #login-overlay {
      position:fixed; inset:0; display:flex; justify-content:center; align-items:center;
      background:#f4f4f4; z-index:99999;
    }
    #login-form {
      padding:40px; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2); text-align:center;
    }
    #login-form h2 { color:#333; margin-bottom:25px; }
    #login-form input {
      margin-bottom:12px; padding:12px; border:1px solid #ddd; width:280px; border-radius:6px; box-sizing:border-box;
    }
    #login-form button {
      padding:12px 30px; background:#007aff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:700;
    }
    #login-form button:hover { background:#005bb5; }
    #login-status { margin-top:15px; color:#e53935; font-size:14px; }
  </style>
</head>

<body>
  <!-- 로그인 -->
  <div id="login-overlay">
    <form id="login-form">
      <h2>CCTV GIS 로그인</h2>
      <input type="text" id="login-username" placeholder="아이디" required><br/>
      <input type="password" id="login-password" placeholder="비밀번호" required><br/>
      <button type="submit">접속</button>
      <p id="login-status"></p>
    </form>
  </div>

  <!-- 지도 컨테이너 -->
  <div id="container">
    <div id="mapWrapper">
      <div id="map"></div>

      <div class="toolbar">
        <button id="btnSatellite" title="위성뷰">🌐</button>
        <button id="roadviewControl" title="로드뷰">🚗</button>
        <button id="btnDistance" title="거리재기">📏</button>
        <button id="btnGroupMST" title="그룹연결">🧩</button>
        <button id="btnCapture" class="capture-btn" title="지도 캡처">📷</button>
      </div>

      <div class="rv-resizer" aria-hidden="true"></div>
    </div>

    <div id="rvWrapper"><div id="roadview"></div></div>
  </div>

  <!-- 전역 유틸(마커 클릭 통제) -->
  <script>
    function setAllMarkersClickable(clickable){
      const list = window.markers || [];
      for (const m of list) { try { m.setClickable(clickable); } catch(e){} }
    }
    function flash(msg){
      const el=document.createElement('div');
      el.textContent=msg;
      el.style.cssText='position:fixed;left:50%;top:14px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;z-index:99999;pointer-events:none';
      document.body.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .25s'; },1100);
      setTimeout(()=>el.remove(),1500);
    }
  </script>

  <!-- 의존 스크립트(기존 기능 살림) -->
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="sel_suggest.js"></script>
  <script src="markers-handler.js"></script>
  <script src="search-suggest.js"></script>
  <script src="drawGroupLinesMST.js"></script>
  <script src="btnDistance.js"></script>
  <script src="roadview.js"></script>
  <script src="btnCapture.js"></script>

  <!-- 지도 로드 & 툴바 배선 -->
  <script>
    // ===== 로그인 & 토큰 =====
    const LOGIN_API = 'https://YOUR_WORKER_SUBDOMAIN.workers.dev/login'; // ← 오빠 워커 /login 로 바꿔줘
    const AUTH_TOKEN_KEY = 'mapAuthToken';

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if (token) loadMapAndFeatures(token);
      else document.getElementById('login-form').addEventListener('submit', handleLoginSubmit);
    });

    async function handleLoginSubmit(e){
      e.preventDefault();
      const id = document.getElementById('login-username').value.trim();
      const pw = document.getElementById('login-password').value.trim();
      const status = document.getElementById('login-status');
      status.textContent = '로그인 중...';
      try{
        const res = await fetch(LOGIN_API, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:id, password:pw}) });
        const data = await res.json().catch(()=> ({}));
        if (res.ok && data?.success && data?.token){
          localStorage.setItem(AUTH_TOKEN_KEY, data.token);
          status.textContent = '로그인 성공! 지도 로드 중...';
          loadMapAndFeatures(data.token);
        } else {
          status.textContent = data?.message || '아이디 또는 비밀번호가 잘못되었습니다.';
        }
      }catch(err){
        console.error(err);
        status.textContent = '네트워크 오류가 발생했습니다.';
      }
    }

    // ===== 지도 로드 & 기능 배선 =====
    let map, geocoder, places;

    function loadMapAndFeatures(token){
      // 로그인 UI → 지도 UI 전환
      document.getElementById('login-overlay').style.display = 'none';
      const container = document.getElementById('container');
      container.style.display = 'block';

      // Kakao Maps 로드
      kakao.maps.load(function(){
        const center = new kakao.maps.LatLng(35.2725308711779, 128.406307024695);
        map = new kakao.maps.Map(document.getElementById('map'), { center, level:4 });
        window.map = map;

        map.setMaxLevel(9);
        geocoder = new kakao.maps.services.Geocoder();
        places   = new kakao.maps.services.Places();

        // 로드뷰 준비 (roadview.js에서 initRoadview가 제공된다고 가정)
        const rvDiv = document.getElementById('roadview');
        const rv = new kakao.maps.Roadview(rvDiv);
        const rvClient = new kakao.maps.RoadviewClient();
        window.__rvInstance = rv;
        window.__rvClient   = rvClient;
        window.__mapInstance= map;

        if (window.RoadviewModule?.initRoadview){
          RoadviewModule.initRoadview(map, rv, rvClient);
        }

        // 거리재기 준비(btnDistance.js가 setupDistance/ toggleDistance 제공 가정)
        if (window.DistanceModule?.setupDistance){
          DistanceModule.setupDistance(map);
        }

        // 외부 데이터 → 마커 생성
        if (window.SEL_SUGGEST && typeof initMarkers === 'function'){
          const unique = new Map(), positions=[];
          for (const it of window.SEL_SUGGEST){
            const lat = +it.lat, lng = +it.lng;
            if (!isFinite(lat) || !isFinite(lng)) continue;
            const key = lat+','+lng; if (unique.has(key)) continue; unique.set(key,true);
            positions.push({
              latlng: new kakao.maps.LatLng(lat,lng),
              content: it.name1 || it.name || '',
              searchName: it.name2 || it.name || '',
              group: it.group || null,
              __lat: lat, __lng: lng
            });
          }
          initMarkers(map, positions);
        }

        // 제안 UI
        if (typeof initSuggestUI === 'function'){
          initSuggestUI({
            map,
            data: window.SEL_SUGGEST || [],
            parent: document.getElementById('mapWrapper'),
            getMarkers: () => window.markers,
            badges: ['line','enclosure','address','ip','group'],
            maxItems: 30, chooseOnEnter: true, openOnFocus: true
          });
        }

        // === 툴바 배선 ===
        wireToolbar(map, rv, rvClient);
      });
    }

    function wireToolbar(map, rv, rvClient){
      const btnSat  = document.getElementById('btnSatellite');
      const btnRV   = document.getElementById('roadviewControl');
      const btnDist = document.getElementById('btnDistance');
      const btnMST  = document.getElementById('btnGroupMST');

      // 위성뷰 토글
      btnSat?.addEventListener('click', ()=>{
        const isRoad = map.getMapTypeId() === kakao.maps.MapTypeId.ROADMAP;
        map.setMapTypeId(isRoad ? kakao.maps.MapTypeId.HYBRID : kakao.maps.MapTypeId.ROADMAP);
        btnSat.classList.toggle('active', isRoad);
      });

      // 로드뷰 토글(roadview.js에서 제공하는 API 우선 사용)
      btnRV?.addEventListener('click', ()=>{
        if (window.RoadviewModule?.toggle){
          RoadviewModule.toggle();
        } else {
          // 폴백: 지도 중심 근방 로드뷰 열기/닫기
          const body = document.body;
          if (body.classList.contains('view_roadview')){
            body.classList.remove('view_roadview');
          } else {
            const pos = map.getCenter();
            rvClient.getNearestPanoId(pos, 50, panoId=>{
              if (!panoId) return flash('주변 로드뷰 없음');
              rv.setPanoId(panoId, pos);
              document.body.classList.add('view_roadview');
            });
          }
        }
      });

      // 거리재기 토글
      btnDist?.addEventListener('click', ()=>{
        if (window.DistanceModule?.toggleDistance){
          DistanceModule.toggleDistance();
          btnDist.classList.toggle('active');
        } else {
          flash('거리재기 모듈(btnDistance.js) 없음');
        }
      });

      // 그룹 MST
      (function(){
        if (!btnMST) return;
        let active = false;
        function normalizeMarkers(){
          (window.markers || []).filter(Boolean).forEach(mk=>{
            const gx = mk.gx || {};
            mk.group = mk.group ?? gx.group ?? gx.grp ?? null;
            mk.name  = mk.name  ?? gx.content ?? gx.searchName ?? gx.name ?? '';
          });
        }
        window.getMarkersByGroup = window.getMarkersByGroup || function(){
          const by={}; (window.markers||[]).forEach(mk=>{
            const g = (mk.group ?? mk.gx?.group ?? null);
            if (!g) return; (by[g] ||= []).push(mk);
          }); return by;
        };
        btnMST.addEventListener('click', ()=>{
          active = !active; btnMST.classList.toggle('active', active);
          if (active){
            // 거리재기 켜져 있으면 끄기
            if (btnDist?.classList.contains('active')) btnDist.click();
            normalizeMarkers();
            if (typeof drawMSTAllGroups === 'function'){ drawMSTAllGroups(map); }
            else flash('drawGroupLinesMST.js 없음');
          } else {
            if (typeof clearMSTLines === 'function') clearMSTLines();
          }
        });
      })();
    }
  </script>
</body>
</html>
