<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>CCTV GIS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>

  <!-- Kakao Maps (deferred, autoload=false) -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>

  <!-- í”„ë¡œì íŠ¸ ê³µìš© ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="style.css"/>

  <!-- ìµœì†Œ ë³´ì¡° ìŠ¤íƒ€ì¼(í•„ìš”í•œ ê²ƒë§Œ) -->
  <style>
    html, body { height:100%; margin:0; }
    #container { position:relative; height:100%; overflow:hidden; display:none; }
    #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
    #map { width:100%; height:100%; cursor:grab; }
    #map:active { cursor:grabbing; }

    /* íˆ´ë°” */
    .toolbar {
      position:fixed; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:10;
    }
    .toolbar button {
      width:42px; height:42px; display:flex; align-items:center; justify-content:center;
      font-size:22px; border:1px solid #ccc; border-radius:10px;
      background:linear-gradient(180deg,#fff 0%,#f8f8f8 100%); color:#333;
      cursor:pointer; transition:.25s; box-shadow:0 2px 5px rgba(0,0,0,.1);
    }
    .toolbar button:hover { transform:translateY(-2px); box-shadow:0 6px 12px rgba(0,0,0,.18); }
    .toolbar button.active {
      border-color:#007aff; color:#007aff;
      background:linear-gradient(180deg,#eaf3ff 0%,#d7e9ff 100%);
      box-shadow:0 0 0 3px rgba(0,122,255,.15) inset, 0 3px 10px rgba(0,0,0,.12);
      transform:translateY(1px);
    }

    /* ë¡œë“œë·° ì˜ì—­(ì´ˆê¸° ë¹„í‘œì‹œ) */
    #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
    #roadview  { width:100%; height:100%; }
    .view_roadview #rvWrapper { display:block; z-index:1; }
    .view_roadview #mapWrapper {
      position:absolute; left:8px; bottom:8px; width:26%; height:26%; min-width:200px; min-height:150px;
      border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2; box-shadow:0 8px 24px rgba(0,0,0,.2);
    }
    /* ë¯¸ë‹ˆë§µ ë¦¬ì‚¬ì´ì €(ë¡œë“œë·°ì¼ ë•Œë§Œ ë…¸ì¶œ) */
    #mapWrapper .rv-resizer {
      position:absolute; right:0; top:0; width:20px; height:20px;
      background:linear-gradient(225deg,#f4f4f4 0%,#f4f4f4 49.9%, transparent 50%);
      cursor:nesw-resize; opacity:.75; display:none; z-index:9999;
    }
    .view_roadview #mapWrapper .rv-resizer { display:block; }

    /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
    #login-overlay {
      position:fixed; inset:0; display:flex; justify-content:center; align-items:center;
      background:#f4f4f4; z-index:99999;
    }
    #login-form {
      padding:40px; background:#fff; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.2); text-align:center;
    }
    #login-form h2 { color:#333; margin-bottom:25px; }
    #login-form input {
      margin-bottom:12px; padding:12px; border:1px solid #ddd; width:280px; border-radius:6px; box-sizing:border-box;
    }
    #login-form button {
      padding:12px 30px; background:#007aff; color:#fff; border:none; border-radius:6px; cursor:pointer; font-weight:700;
    }
    #login-form button:hover { background:#005bb5; }
    #login-status { margin-top:15px; color:#e53935; font-size:14px; }
  </style>
</head>

<body>
  <!-- ë¡œê·¸ì¸ -->
  <div id="login-overlay">
    <form id="login-form">
      <h2>CCTV GIS ë¡œê·¸ì¸</h2>
      <input type="text" id="login-username" placeholder="ì•„ì´ë””" required><br/>
      <input type="password" id="login-password" placeholder="ë¹„ë°€ë²ˆí˜¸" required><br/>
      <button type="submit">ì ‘ì†</button>
      <p id="login-status"></p>
    </form>
  </div>

  <!-- ì§€ë„ ì»¨í…Œì´ë„ˆ -->
  <div id="container">
    <div id="mapWrapper">
      <div id="map"></div>

      <div class="toolbar">
        <button id="btnSatellite" title="ìœ„ì„±ë·°">ğŸŒ</button>
        <button id="roadviewControl" title="ë¡œë“œë·°">ğŸš—</button>
        <button id="btnDistance" title="ê±°ë¦¬ì¬ê¸°">ğŸ“</button>
        <button id="btnGroupMST" title="ê·¸ë£¹ì—°ê²°">ğŸ§©</button>
        <button id="btnCapture" class="capture-btn" title="ì§€ë„ ìº¡ì²˜">ğŸ“·</button>
      </div>

      <div class="rv-resizer" aria-hidden="true"></div>
    </div>

    <div id="rvWrapper"><div id="roadview"></div></div>
  </div>

  <!-- ì „ì—­ ìœ í‹¸(ë§ˆì»¤ í´ë¦­ í†µì œ) -->
  <script>
    function setAllMarkersClickable(clickable){
      const list = window.markers || [];
      for (const m of list) { try { m.setClickable(clickable); } catch(e){} }
    }
    function flash(msg){
      const el=document.createElement('div');
      el.textContent=msg;
      el.style.cssText='position:fixed;left:50%;top:14px;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;z-index:99999;pointer-events:none';
      document.body.appendChild(el);
      setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .25s'; },1100);
      setTimeout(()=>el.remove(),1500);
    }
  </script>

  <!-- ì˜ì¡´ ìŠ¤í¬ë¦½íŠ¸(ê¸°ì¡´ ê¸°ëŠ¥ ì‚´ë¦¼) -->
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="sel_suggest.js"></script>
  <script src="markers-handler.js"></script>
  <script src="search-suggest.js"></script>
  <script src="drawGroupLinesMST.js"></script>
  <script src="btnDistance.js"></script>
  <script src="roadview.js"></script>
  <script src="btnCapture.js"></script>

  <!-- ì§€ë„ ë¡œë“œ & íˆ´ë°” ë°°ì„  -->
  <script>
    // ===== ë¡œê·¸ì¸ & í† í° =====
    const LOGIN_API = 'https://YOUR_WORKER_SUBDOMAIN.workers.dev/login'; // â† ì˜¤ë¹  ì›Œì»¤ /login ë¡œ ë°”ê¿”ì¤˜
    const AUTH_TOKEN_KEY = 'mapAuthToken';

    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem(AUTH_TOKEN_KEY);
      if (token) loadMapAndFeatures(token);
      else document.getElementById('login-form').addEventListener('submit', handleLoginSubmit);
    });

    async function handleLoginSubmit(e){
      e.preventDefault();
      const id = document.getElementById('login-username').value.trim();
      const pw = document.getElementById('login-password').value.trim();
      const status = document.getElementById('login-status');
      status.textContent = 'ë¡œê·¸ì¸ ì¤‘...';
      try{
        const res = await fetch(LOGIN_API, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:id, password:pw}) });
        const data = await res.json().catch(()=> ({}));
        if (res.ok && data?.success && data?.token){
          localStorage.setItem(AUTH_TOKEN_KEY, data.token);
          status.textContent = 'ë¡œê·¸ì¸ ì„±ê³µ! ì§€ë„ ë¡œë“œ ì¤‘...';
          loadMapAndFeatures(data.token);
        } else {
          status.textContent = data?.message || 'ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.';
        }
      }catch(err){
        console.error(err);
        status.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      }
    }

    // ===== ì§€ë„ ë¡œë“œ & ê¸°ëŠ¥ ë°°ì„  =====
    let map, geocoder, places;

    function loadMapAndFeatures(token){
      // ë¡œê·¸ì¸ UI â†’ ì§€ë„ UI ì „í™˜
      document.getElementById('login-overlay').style.display = 'none';
      const container = document.getElementById('container');
      container.style.display = 'block';

      // Kakao Maps ë¡œë“œ
      kakao.maps.load(function(){
        const center = new kakao.maps.LatLng(35.2725308711779, 128.406307024695);
        map = new kakao.maps.Map(document.getElementById('map'), { center, level:4 });
        window.map = map;

        map.setMaxLevel(9);
        geocoder = new kakao.maps.services.Geocoder();
        places   = new kakao.maps.services.Places();

        // ë¡œë“œë·° ì¤€ë¹„ (roadview.jsì—ì„œ initRoadviewê°€ ì œê³µëœë‹¤ê³  ê°€ì •)
        const rvDiv = document.getElementById('roadview');
        const rv = new kakao.maps.Roadview(rvDiv);
        const rvClient = new kakao.maps.RoadviewClient();
        window.__rvInstance = rv;
        window.__rvClient   = rvClient;
        window.__mapInstance= map;

        if (window.RoadviewModule?.initRoadview){
          RoadviewModule.initRoadview(map, rv, rvClient);
        }

        // ê±°ë¦¬ì¬ê¸° ì¤€ë¹„(btnDistance.jsê°€ setupDistance/ toggleDistance ì œê³µ ê°€ì •)
        if (window.DistanceModule?.setupDistance){
          DistanceModule.setupDistance(map);
        }

        // ì™¸ë¶€ ë°ì´í„° â†’ ë§ˆì»¤ ìƒì„±
        if (window.SEL_SUGGEST && typeof initMarkers === 'function'){
          const unique = new Map(), positions=[];
          for (const it of window.SEL_SUGGEST){
            const lat = +it.lat, lng = +it.lng;
            if (!isFinite(lat) || !isFinite(lng)) continue;
            const key = lat+','+lng; if (unique.has(key)) continue; unique.set(key,true);
            positions.push({
              latlng: new kakao.maps.LatLng(lat,lng),
              content: it.name1 || it.name || '',
              searchName: it.name2 || it.name || '',
              group: it.group || null,
              __lat: lat, __lng: lng
            });
          }
          initMarkers(map, positions);
        }

        // ì œì•ˆ UI
        if (typeof initSuggestUI === 'function'){
          initSuggestUI({
            map,
            data: window.SEL_SUGGEST || [],
            parent: document.getElementById('mapWrapper'),
            getMarkers: () => window.markers,
            badges: ['line','enclosure','address','ip','group'],
            maxItems: 30, chooseOnEnter: true, openOnFocus: true
          });
        }

        // === íˆ´ë°” ë°°ì„  ===
        wireToolbar(map, rv, rvClient);
      });
    }

    function wireToolbar(map, rv, rvClient){
      const btnSat  = document.getElementById('btnSatellite');
      const btnRV   = document.getElementById('roadviewControl');
      const btnDist = document.getElementById('btnDistance');
      const btnMST  = document.getElementById('btnGroupMST');

      // ìœ„ì„±ë·° í† ê¸€
      btnSat?.addEventListener('click', ()=>{
        const isRoad = map.getMapTypeId() === kakao.maps.MapTypeId.ROADMAP;
        map.setMapTypeId(isRoad ? kakao.maps.MapTypeId.HYBRID : kakao.maps.MapTypeId.ROADMAP);
        btnSat.classList.toggle('active', isRoad);
      });

      // ë¡œë“œë·° í† ê¸€(roadview.jsì—ì„œ ì œê³µí•˜ëŠ” API ìš°ì„  ì‚¬ìš©)
      btnRV?.addEventListener('click', ()=>{
        if (window.RoadviewModule?.toggle){
          RoadviewModule.toggle();
        } else {
          // í´ë°±: ì§€ë„ ì¤‘ì‹¬ ê·¼ë°© ë¡œë“œë·° ì—´ê¸°/ë‹«ê¸°
          const body = document.body;
          if (body.classList.contains('view_roadview')){
            body.classList.remove('view_roadview');
          } else {
            const pos = map.getCenter();
            rvClient.getNearestPanoId(pos, 50, panoId=>{
              if (!panoId) return flash('ì£¼ë³€ ë¡œë“œë·° ì—†ìŒ');
              rv.setPanoId(panoId, pos);
              document.body.classList.add('view_roadview');
            });
          }
        }
      });

      // ê±°ë¦¬ì¬ê¸° í† ê¸€
      btnDist?.addEventListener('click', ()=>{
        if (window.DistanceModule?.toggleDistance){
          DistanceModule.toggleDistance();
          btnDist.classList.toggle('active');
        } else {
          flash('ê±°ë¦¬ì¬ê¸° ëª¨ë“ˆ(btnDistance.js) ì—†ìŒ');
        }
      });

      // ê·¸ë£¹ MST
      (function(){
        if (!btnMST) return;
        let active = false;
        function normalizeMarkers(){
          (window.markers || []).filter(Boolean).forEach(mk=>{
            const gx = mk.gx || {};
            mk.group = mk.group ?? gx.group ?? gx.grp ?? null;
            mk.name  = mk.name  ?? gx.content ?? gx.searchName ?? gx.name ?? '';
          });
        }
        window.getMarkersByGroup = window.getMarkersByGroup || function(){
          const by={}; (window.markers||[]).forEach(mk=>{
            const g = (mk.group ?? mk.gx?.group ?? null);
            if (!g) return; (by[g] ||= []).push(mk);
          }); return by;
        };
        btnMST.addEventListener('click', ()=>{
          active = !active; btnMST.classList.toggle('active', active);
          if (active){
            // ê±°ë¦¬ì¬ê¸° ì¼œì ¸ ìˆìœ¼ë©´ ë„ê¸°
            if (btnDist?.classList.contains('active')) btnDist.click();
            normalizeMarkers();
            if (typeof drawMSTAllGroups === 'function'){ drawMSTAllGroups(map); }
            else flash('drawGroupLinesMST.js ì—†ìŒ');
          } else {
            if (typeof clearMSTLines === 'function') clearMSTLines();
          }
        });
      })();
    }
  </script>
</body>
</html>
