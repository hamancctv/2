<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>GIS 모바일</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://hamancctv.github.io/2/favicon.ico" sizes="32x32"/>
  <link rel="stylesheet" href="https://hamancctv.github.io/2/style.css">
  <style>
    #mapWrapper { position: relative; }
  </style>
</head>
<body>
  <div id="alert-overlay"><div id="alert-message"></div></div>
  <button id="btnDistance">거리</button>

  <div id="container">
    <div id="rvWrapper">
      <div id="roadview" style="width:100%;height:100%"></div>
      <div id="close" title="로드뷰닫기" onclick="closeRoadview()"><span class="img"></span></div>
    </div>
    <div id="mapWrapper">
      <div id="map" style="width:100%;height:100%"></div>
      <div id="roadviewControl" onclick="setRoadviewRoad()"></div>
    </div>
  </div>

  <div class="toolbar-right">
    <input type="text" id="gpsyx" class="input-common" inputmode="none"
           value="35.2725308711779, 128.406307024695"/>
    <button id="btn_input_copy" class="btn-common">복사</button>
  </div>

  <div class="custom_typecontrol2_m radius_border">
    <span id="toggle_group" class="btn btn-common">회선</span>
    <span id="btnCurrentMe" class="btn btn-common" onclick="toggleMyLocation()">위치</span>
    <span id="btnTrackMe" class="btn btn-common" onclick="toggleTracking()">추적</span>
  </div>

  <!-- 📌 필수 라이브러리 -->
  <script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services,clusterer,drawing&autoload=false"></script>
  <script src="https://code.jquery.com/jquery-3.6.1.js"></script>

  <!-- 📌 외부 스크립트 (중복 제거 후 유지) -->
  <script src="https://hamancctv.github.io/2/sel_suggest.js"></script>
  <script src="https://hamancctv.github.io/2/markers-handler.js"></script>
  <script src="https://hamancctv.github.io/2/drawGroupLinesMST.js?v=20250929a"></script>
  <script src="https://hamancctv.github.io/2/btnDistance.js?v=20250929a"></script>

  <!-- 📌 초기화 스크립트 -->
  <script>
    kakao.maps.load(function () {
      // === 지도 생성 ===
      const mapCenter = new kakao.maps.LatLng(35.2725308711779, 128.406307024695);
      const map = new kakao.maps.Map(document.getElementById('map'), { center: mapCenter, level: 4 });
      map.setMaxLevel(9);
      window.map = map;

      // === 로드뷰 ===
      var rv = new kakao.maps.Roadview(document.getElementById('roadview'));
      var rvClient = new kakao.maps.RoadviewClient();
      var overlayOn = false;
      var marker = new kakao.maps.Marker({
        image: new kakao.maps.MarkerImage(
          'https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png',
          new kakao.maps.Size(26,46),
          { spriteSize:new kakao.maps.Size(1666,168), spriteOrigin:new kakao.maps.Point(705,114), offset:new kakao.maps.Point(13,46) }
        ),
        position: mapCenter, draggable: true
      });

      kakao.maps.event.addListener(rv,'position_changed',function(){
        const rvPos = rv.getPosition(); map.setCenter(rvPos); if(overlayOn) marker.setPosition(rvPos);
      });
      kakao.maps.event.addListener(marker,'dragend',()=>toggleRoadview(marker.getPosition()));
      kakao.maps.event.addListener(map,'click',function(mouseEvent){
        if(!overlayOn) return;
        const position = mouseEvent.latLng; marker.setPosition(position); toggleRoadview(position);
      });
      function toggleRoadview(position){
        rvClient.getNearestPanoId(position, 50, function(panoId) {
          if (panoId === null) toggleMapWrapper(true, position);
          else { toggleMapWrapper(false, position); rv.setPanoId(panoId, position); }
        });
      }
      function toggleMapWrapper(active, position) {
        const container = document.getElementById('container');
        if (active) { container.className=''; map.relayout(); map.setCenter(position); }
        else {
          if (container.className.indexOf('view_roadview') === -1) {
            container.className='view_roadview'; map.relayout(); map.setCenter(position);
          }
        }
      }
      function toggleOverlay(active) {
        if (active) {
          overlayOn = true; map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
          marker.setMap(map); if (window.marker1) window.marker1.setMap(null);
          marker.setPosition(map.getCenter()); toggleRoadview(map.getCenter());
        } else {
          overlayOn = false; map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
          marker.setMap(null); if (window.marker1) window.marker1.setMap(map);
        }
      }
      window.setRoadviewRoad = function(){
        var c = document.getElementById('roadviewControl');
        if (c.className.indexOf('active') === -1) { c.className='active'; toggleOverlay(true); }
        else { c.className=''; toggleOverlay(false); }
      };
      window.closeRoadview = function(){ toggleMapWrapper(true, marker.getPosition()); };

      // === 지도 타입 컨트롤 ===
      var mapTypeControl = new kakao.maps.MapTypeControl();
      map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPLEFT);

      // === 내 위치 / 추적 ===
      var myLocationOn=false, trackOn=false, myLocationMarker=null, trackMarker=null, trackInterval=null, watchId=null;
      var markerImage = new kakao.maps.MarkerImage('https://hamancctv.github.io/2/icon-target.png', new kakao.maps.Size(32,32), { offset: new kakao.maps.Point(16,16) });
      window.toggleMyLocation = function(){
        if(trackOn) stopTracking();
        if(!myLocationOn){
          myLocationOn=true; document.getElementById('btnCurrentMe').classList.add('selected_btn');
          navigator.geolocation.getCurrentPosition(function(pos){ showMyLocation(pos.coords.latitude,pos.coords.longitude); }, geoError, {enableHighAccuracy:true});
        } else {
          myLocationOn=false; document.getElementById('btnCurrentMe').classList.remove('selected_btn');
          if(myLocationMarker){ myLocationMarker.setMap(null); myLocationMarker=null; }
        }
      };
      function showMyLocation(lat,lng){
        var latLng=new kakao.maps.LatLng(lat,lng);
        if(!myLocationMarker){
          myLocationMarker=new kakao.maps.Marker({ position:latLng, map:map, image:markerImage });
          kakao.maps.event.addListener(myLocationMarker,'click',function(){ map.panTo(myLocationMarker.getPosition()); map.setLevel(4); });
        } else { myLocationMarker.setPosition(latLng); myLocationMarker.setMap(map); }
        map.panTo(latLng); map.setLevel(5);
      }
      window.toggleTracking = function(){
        if(myLocationOn) toggleMyLocation();
        if(!trackOn) startTracking(); else stopTracking();
      };
      function startTracking(){
        trackOn=true; document.getElementById('btnTrackMe').classList.add('selected_btn');
        watchId = navigator.geolocation.watchPosition(function(pos){
          var latLng=new kakao.maps.LatLng(pos.coords.latitude,pos.coords.longitude);
          if(!trackMarker){ trackMarker=new kakao.maps.Marker({position:latLng,map:map,image:markerImage}); }
          else { trackMarker.setPosition(latLng); trackMarker.setMap(map); }
          map.panTo(latLng);
        }, geoError, {enableHighAccuracy:true});
        trackInterval=setInterval(()=>{ if(trackMarker) trackMarker.setVisible(!trackMarker.getVisible()); }, 500);
      }
      function stopTracking(){
        trackOn=false; document.getElementById('btnTrackMe').classList.remove('selected_btn');
        if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
        if(trackInterval){ clearInterval(trackInterval); trackInterval=null; }
        if(trackMarker){ trackMarker.setVisible(true); trackMarker.setMap(null); trackMarker=null; }
      }
      function geoError(err){ console.error('GPS error:', err); }

      // === 좌표 input 업데이트 ===
      kakao.maps.event.addListener(map,'center_changed',function(){
        var latlng = map.getCenter(); $('#gpsyx').val(latlng.getLat()+', '+latlng.getLng());
      });

      // === 복사 버튼 ===
      document.getElementById("btn_input_copy").onclick = function(){
        const g = document.getElementById("gpsyx"); g.select(); document.execCommand('copy');
      };

      // === positions 생성 ===
      const positions = (window.SEL_SUGGEST || [])
       .map(it => {
         const lat = parseFloat(it.lat);
         const lng = parseFloat(it.lng);
         if (!isFinite(lat) || !isFinite(lng)) return null;
         return {
           latlng: new kakao.maps.LatLng(lat, lng),
           content: it.name,
           group: it.line || null
         };
       })
       .filter(Boolean);

      // 좌표 중복 제거
      const unique={}, filtered=[];
      for (let i=0;i<positions.length;i++){
        const lat=positions[i].latlng.getLat(), lng=positions[i].latlng.getLng();
        const key = lat+","+lng;
        if (!unique[key]) { unique[key]=true; filtered.push(positions[i]); }
      }

      // === 마커 생성 ===
      if (window.initMarkers) initMarkers(map, filtered);

      // === 회선 토글 ===
      const toggleGroupBtn = document.getElementById("toggle_group");
      if (window.drawGroupLinesMST) {
        toggleGroupBtn.addEventListener("click", function () {
          drawGroupLinesMST(map);
          toggleGroupBtn.classList.toggle("selected_btn");
        });
      }

      // === 검색창/제안 UI ===
      if (window.initSuggestUI) {
          const suggestUI = initSuggestUI({
            map,
            data: window.SEL_SUGGEST,
            parent: document.getElementById('mapWrapper'),
            getMarkers: () => window.markers,
            badges: ['line','encloser','ip'],
            maxItems: 30,
            chooseOnEnter: true,
            openOnFocus: true
          });
      }
    });
  </script>
</body>
</html>
