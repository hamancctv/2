<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>GIS 라이트 (로드뷰 안정패치)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>
<link rel="stylesheet" href="https://hamancctv.github.io/2/style.css" />

<style>
html, body { height:100%; margin:0; }
#container { position:relative; height:100%; overflow:hidden; }
#mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
#map { width:100%; height:100%; }
#rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
#roadview  { width:100%; height:100%; }
.view_roadview #rvWrapper { display:block; z-index:1; }
.view_roadview #mapWrapper {
  position:absolute; left:8px; bottom:8px;
  width:26%; height:26%;
  min-width:200px; min-height:150px;
  border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2;
  box-shadow:0 8px 24px rgba(0,0,0,.2);
}
#close {
  position:absolute; top:8px; left:8px;
  padding:6px; background:#fff; border:1px solid #c8c8c8; border-radius:6px;
  cursor:pointer; z-index:3; box-shadow:0 1px #888;
}
#close .img {
  display:block; width:14px; height:14px;
  background:url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/rv_close.png) no-repeat;
}
.toolbar { position:fixed; top:60px; left:10px; display:flex; flex-direction:column; gap:8px; z-index:10; }
.btn-satellite, #roadviewControl {
  width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center;
  border:1px solid #ccc; border-radius:8px; background:#fff; color:#555;
  cursor:pointer; transition:all .2s ease; box-sizing:border-box;
}
.btn-satellite:hover, #roadviewControl:hover { box-shadow:0 3px 12px rgba(0,0,0,.12); }
.btn-satellite.selected { border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff; }
#roadviewControl.active{ border-color:#007aff; box-shadow:0 0 0 2px rgba(0,122,255,.15) inset; color:#007aff; }
#roadviewControl::before{
  content:""; width:18px; height:18px; border-radius:50%;
  display:block; background: radial-gradient(#fff 0 28%, currentColor 29% 100%);
}
#mapWrapper .rv-resizer{
  position:absolute; right:6px; top:6px;
  width:16px; height:16px;
  border:1px solid #bbb; border-radius:4px; background:#fff;
  box-shadow:0 1px 3px rgba(0,0,0,.2);
  cursor:nesw-resize;
  z-index:650; display:none;
}
.view_roadview #mapWrapper .rv-resizer{ display:block; }

/* === MapWalker === */
.MapWalker {position:absolute; margin:-26px 0 0 -51px; cursor:grab; z-index:2147483647;}
.MapWalker.dragging{ cursor:grabbing; }
.MapWalker .figure {
  position:absolute; width:25px; left:38px; top:-2px; height:39px;
  background:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png) -298px -114px no-repeat;
  pointer-events:none;
}
.MapWalker .angleBase,.MapWalker .angleFront{
  position:absolute; left:0; top:0; width:102px; height:52px;
  background-image:url(https://t1.daumcdn.net/localimg/localimages/07/2018/pc/roadview_minimap_wk_2018.png);
  background-repeat:no-repeat;
  filter:sepia(1)saturate(5.5)hue-rotate(8deg)brightness(1.12)contrast(0.98);
}
.MapWalker .angleBase{background-position:-834px -2px;opacity:.18;}
.MapWalker .angleFront{opacity:.92;}
</style>
</head>
<body>
<div id="container">
  <div id="mapWrapper">
    <div id="map"></div>
    <div class="toolbar">
      <button id="btnSatellite" class="btn-satellite" title="위성뷰">
        <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>
      </button>
      <button id="roadviewControl" title="로드뷰"></button>
    </div>
    <div class="rv-resizer" aria-hidden="true"></div>
  </div>
  <div id="rvWrapper">
    <div id="roadview"></div>
    <div id="close"><span class="img"></span></div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
<script src="https://hamancctv.github.io/2/sel_suggest.js"></script>
<script src="https://hamancctv.github.io/2/markers-handler.js"></script>
<script src="https://hamancctv.github.io/2/search-suggest.js"></script>
<script src="https://hamancctv.github.io/2/drawGroupLinesMST.js"></script>
<script src="https://hamancctv.github.io/2/btnDistance.js"></script>

<script>
let map, rv, rvClient, geocoder, places;
let overlayOn=false, mapWalker=null, pickMode=false;
const __rvOverlayRegistry = new Set();
function __rvIsWalker(o){return mapWalker && o===mapWalker.walker;}

/* ===== 기본 패치 유지 ===== */
function patchOverlayZTracking(){
  const classes=[kakao.maps.CustomOverlay,kakao.maps.Marker,kakao.maps.Polyline,kakao.maps.Circle,kakao.maps.Rectangle,kakao.maps.Ellipse].filter(Boolean);
  classes.forEach(C=>{
    if(!C||!C.prototype||C.prototype.__rvPatched)return;
    const origSetMap=C.prototype.setMap;
    if(typeof origSetMap!=='function')return;
    C.prototype.__rvOriginalSetMap=origSetMap;
    C.prototype.setMap=function(m){
      const ret=origSetMap.apply(this,arguments);
      if(m)__rvOverlayRegistry.add(this);else __rvOverlayRegistry.delete(this);
      return ret;
    };
    C.prototype.__rvPatched=true;
  });
}

/* ===== zIndex 조정 비활성화 ===== */
function patchZIndexSetter(){
  console.log("[RV] zIndex patch disabled — markers retain normal order");
}

/* ===== 마커/오버레이 클릭 무시 ===== */
function interceptMarkerClicks(map){
  const markers=window.markers||[];
  markers.forEach(m=>{
    kakao.maps.event.addListener(m,'click',function(){
      if(overlayOn){
        const pos=m.getPosition();
        kakao.maps.event.trigger(map,'click',{latLng:pos});
      }
    });
  });
  document.body.addEventListener('click',e=>{
    if(!overlayOn)return;
    const el=e.target.closest('.overlay-hover,.overlay-click');
    if(el){
      e.stopPropagation();
      const lat=parseFloat(el.dataset.lat),lng=parseFloat(el.dataset.lng);
      if(!isNaN(lat)&&!isNaN(lng)){
        kakao.maps.event.trigger(map,'click',{latLng:new kakao.maps.LatLng(lat,lng)});
      }
    }
  },true);
}

/* ===== Overlay mute/unmute ===== */
function __rvMuteOverlay(o){
  try{
    if(__rvIsWalker(o))return;
    if(typeof o.setClickable==='function')o.setClickable(false);
    if(typeof o.setDraggable==='function')o.setDraggable(false);
    if(typeof o.getContent==='function'){
      const el=o.getContent();if(el&&el.style)el.style.pointerEvents='none';
    }
  }catch(e){}
}
function __rvUnmuteOverlay(o){
  try{
    if(__rvIsWalker(o))return;
    if(typeof o.setClickable==='function')o.setClickable(true);
    if(typeof o.setDraggable==='function')o.setDraggable(false);
    if(typeof o.getContent==='function'){
      const el=o.getContent();if(el&&el.style)el.style.pointerEvents='';
    }
  }catch(e){}
}
function setAllOverlaysClickForRV(disable){
  __rvOverlayRegistry.forEach(o=>{disable?__rvMuteOverlay(o):__rvUnmuteOverlay(o);});
}

/* ===== MapWalker ===== */
function MapWalker(position){
  const content=document.createElement('div');
  const angleBase=document.createElement('div');
  const angleFront=document.createElement('div');
  const figure=document.createElement('div');
  content.className='MapWalker';
  angleBase.className='angleBase';
  angleFront.className='angleFront';
  figure.className='figure';
  content.appendChild(angleBase);
  content.appendChild(angleFront);
  content.appendChild(figure);
  const walker=new kakao.maps.CustomOverlay({position,content,yAnchor:1,clickable:true});
  walker.setZIndex(2147483647);
  this.walker=walker;this.content=content;this.position=position;
  const self=this;
  let dragging=false,startX=0,startY=0,startPt=null,moved=false;
  function onDown(ev){
    if(!overlayOn)return;
    if(ev.touches&&ev.touches.length>1)return;
    ev.preventDefault();
    content.classList.add('dragging');dragging=true;moved=false;
    const t=ev.touches?ev.touches[0]:ev;
    startX=t.clientX;startY=t.clientY;
    const proj=map.getProjection();startPt=proj.containerPointFromCoords(self.position);
    map.setDraggable(false);map.setZoomable(false);
    document.addEventListener('mousemove',onMove,{passive:false});
    document.addEventListener('mouseup',onUp,{passive:false});
    document.addEventListener('touchmove',onMove,{passive:false});
    document.addEventListener('touchend',onUp,{passive:false});
  }
  function onMove(ev){
    if(!dragging)return;
    if(ev.touches&&ev.touches.length>1)return;
    ev.preventDefault();
    const t=ev.touches?ev.touches[0]:ev;
    const dx=t.clientX-startX,dy=t.clientY-startY;
    if(Math.abs(dx)+Math.abs(dy)>3)moved=true;
    const proj=map.getProjection();
    const newPt=new kakao.maps.Point(startPt.x+dx,startPt.y+dy);
    const newPos=proj.coordsFromContainerPoint(newPt);
    self.setPosition(newPos);
  }
  function onUp(ev){
    if(!dragging)return;
    ev.preventDefault();dragging=false;
    content.classList.remove('dragging');
    map.setDraggable(true);map.setZoomable(true);
    if(moved){try{setRoadviewAt(self.position);}catch(e){}}
    document.removeEventListener('mousemove',onMove);
    document.removeEventListener('mouseup',onUp);
    document.removeEventListener('touchmove',onMove);
    document.removeEventListener('touchend',onUp);
  }
  content.addEventListener('mousedown',onDown,{passive:false});
  content.addEventListener('touchstart',onDown,{passive:false});
}
MapWalker.prototype.setAngle=function(a){
  const idx=Math.floor((((a%360)+371.25)%360)/22.5);
  this.content.className='MapWalker m'+idx;
};
MapWalker.prototype.setPosition=function(p){this.position=p;this.walker.setPosition(p);}
MapWalker.prototype.setMap=function(m){this.walker.setMap(m);}

/* ===== 로드뷰 ===== */
function findNearestPanoId(position,cb,radii=[50,100,200,400,800,1600,3000]){
  let i=0;(function next(){if(i>=radii.length)return cb(null);
  rvClient.getNearestPanoId(position,radii[i],id=>{if(id)cb(id);else{i++;next();}});})();}

function setRoadviewAt(position){
  const container=document.getElementById('container');
  findNearestPanoId(position,panoId=>{
    if(!panoId){alert('근처에 로드뷰가 없습니다');return;}
    container.classList.add('view_roadview');
    rv.setPanoId(panoId,position);
    map.setCenter(position);
    if(mapWalker)mapWalker.setPosition(position);
  });
}

function toggleOverlay(active){
  const btn=document.getElementById('roadviewControl');
  if(active){
    overlayOn=true;btn.classList.add('active');
    map.addOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    setAllOverlaysClickForRV(true);
    interceptMarkerClicks(map);
    if(!mapWalker){mapWalker=new MapWalker(map.getCenter());mapWalker.setMap(map);}
    else{mapWalker.setPosition(map.getCenter());mapWalker.setMap(map);}
    mapWalker.walker.setZIndex(2147483647);
    mapWalker.content.style.zIndex='2147483647';
    setRoadviewAt(map.getCenter());
  }else{
    overlayOn=false;pickMode=false;btn.classList.remove('active');
    map.removeOverlayMapTypeId(kakao.maps.MapTypeId.ROADVIEW);
    setAllOverlaysClickForRV(false);
    if(mapWalker){mapWalker.setMap(null);}
    document.getElementById('container').classList.remove('view_roadview');
    map.relayout();
  }
}

/* ===== 초기화 ===== */
kakao.maps.load(function(){
  const center=new kakao.maps.LatLng(35.2725308711779,128.406307024695);
  map=new kakao.maps.Map(document.getElementById('map'),{center,level:4});
  map.setMaxLevel(9);
  geocoder=new kakao.maps.services.Geocoder();
  places=new kakao.maps.services.Places();
  rvClient=new kakao.maps.RoadviewClient();
  rv=new kakao.maps.Roadview(document.getElementById('roadview'));
  patchOverlayZTracking();
  patchZIndexSetter();

  kakao.maps.event.addListener(rv,'viewpoint_changed',()=>{
    if(!overlayOn||!mapWalker)return;
    const vp=rv.getViewpoint();mapWalker.setAngle(vp.pan);
  });
  kakao.maps.event.addListener(rv,'position_changed',()=>{
    if(!overlayOn)return;
    const pos=rv.getPosition();map.setCenter(pos);
    if(mapWalker)mapWalker.setPosition(pos);
  });
  kakao.maps.event.addListener(map,'click',e=>{
    if(!overlayOn)return;
    const pos=e.latLng;setRoadviewAt(pos);
  });
  document.getElementById('roadviewControl').onclick=()=>toggleOverlay(!overlayOn);
  document.getElementById('close').onclick=()=>toggleOverlay(false);
  const btnSat=document.getElementById('btnSatellite');
  btnSat.onclick=function(){
    if(map.getMapTypeId()===kakao.maps.MapTypeId.ROADMAP){
      map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);this.classList.add('selected');
    }else{map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);this.classList.remove('selected');}
  };

  if(window.SEL_SUGGEST&&typeof initMarkers==='function'){
    const unique=new Map(),positions=[];
    for(const it of window.SEL_SUGGEST){
      const lat=parseFloat(it.lat),lng=parseFloat(it.lng);
      if(!isFinite(lat)||!isFinite(lng))continue;
      const key=lat+','+lng;if(unique.has(key))continue;unique.set(key,true);
      positions.push({latlng:new kakao.maps.LatLng(lat,lng),content:it.name1||it.name||'',group:it.group||null,__lat:lat,__lng:lng});
    }
    initMarkers(map,positions);
  }

  if(typeof initSuggestUI==='function'){
    initSuggestUI({
      map,
      data:window.SEL_SUGGEST||[],
      parent:document.getElementById('mapWrapper'),
      getMarkers:()=>window.markers,
      badges:['line','enclosure','address','ip','group'],
      maxItems:30
    });
  }
});
</script>
</body>
</html>
