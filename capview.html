<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>CAPVIEW</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  #wrap{position:fixed;inset:0}
  #map,#roadview{position:absolute;inset:0}
  #ui{
    position:fixed;bottom:16px;left:50%;transform:translateX(-50%);
    z-index:9999;display:flex;gap:8px;align-items:center
  }
  #btnStart{
    font:600 14px/1.2 system-ui;background:#111;color:#fff;border:1px solid #333;border-radius:10px;
    padding:10px 14px;box-shadow:0 4px 14px rgba(0,0,0,.4);cursor:pointer
  }
  #hint{color:#bbb;font:500 12px/1.2 system-ui}
  #warn{position:fixed;inset:0;display:none;align-items:center;justify-content:center;color:#fff;font:600 14px/1.4 system-ui}
</style>
<!-- ğŸ”‘ ë‚˜ì¤‘ì— ì—¬ê¸°ë§Œ ë„¤ JavaScript í‚¤ë¡œ ë°”ê¾¸ë©´ ë¨ -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>
</head>
<body>
  <div id="wrap">
    <div id="map"></div>
    <div id="roadview" style="display:none"></div>
  </div>

  <div id="ui">
    <button id="btnStart">ğŸ“¸ ìº¡ì²˜ ì‹œì‘</button>
    <span id="hint">ê¶Œí•œ ì°½ì—ì„œ <b>CAPVIEW íƒ­</b>ì„ ì„ íƒí•˜ì„¸ìš”</span>
  </div>

  <div id="warn"></div>

<script>
(async function(){
  /* ---------------- CAPTURE_DATA ë°›ê¸° (ì¦‰ì‹œ+ëŒ€ê¸°) ---------------- */
  async function getPayloadWithWait(timeoutMs=3000){
    const read = () => { try { return JSON.parse(localStorage.getItem("CAPTURE_DATA") || "null"); } catch(_) { return null; } };
    let data = read();
    if (data) return data;

    const byStorage = new Promise(resolve=>{
      const h=(e)=>{ if(e.key==="CAPTURE_DATA" && e.newValue){ window.removeEventListener("storage",h); resolve(JSON.parse(e.newValue)); } };
      window.addEventListener("storage", h);
      window.addEventListener("message",(ev)=>{ if(ev.data?.type==="CAPTURE_DATA_READY"){ const d=read(); if(d) resolve(d); }},{once:true});
    });
    const byTimeout = new Promise(res=> setTimeout(()=> res(read()), timeoutMs));
    data = await Promise.race([byStorage, byTimeout]);
    return data || read();
  }

  /* ---------------- Kakao SDK ì²´í¬ ---------------- */
  const warn = document.getElementById('warn');
  if (typeof kakao === "undefined" || !kakao.maps) {
    warn.style.display='flex';
    warn.textContent = "âš ï¸ Kakao ì§€ë„ SDK ë¡œë“œ ì‹¤íŒ¨. ë‚˜ì¤‘ì— í‚¤ë§Œ ë„£ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
    // SDK ì—†ì´ë„ í™”ë©´ ìº¡ì²˜ëŠ” ê°€ëŠ¥í•˜ì§€ë§Œ ë¹ˆ í™”ë©´ì¼ ìˆ˜ ìˆìŒ â†’ ë²„íŠ¼ì€ ê³„ì† í™œì„±í™”
  }

  /* ---------------- ë°ì´í„° ìˆ˜ì‹  ---------------- */
  const data = await getPayloadWithWait(3000);
  if (!data) {
    warn.style.display='flex';
    warn.textContent = "CAPTURE_DATAë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì°½ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
    // ê·¸ë˜ë„ ìº¡ì²˜ ë²„íŠ¼ì€ ëˆŒëŸ¬ë³¼ ìˆ˜ ìˆê²Œ ë‘ 
  }

  const { rv=false, pos=null, center=null, level=3, type=null, markers=[], addrName: preAddrName="" } = data || {};
  window.__IS_RV__ = !!rv;

  /* ---------------- ì§€ë„/ë¡œë“œë·° êµ¬ì„± ---------------- */
  const mapEl = document.getElementById('map');
  const rvEl  = document.getElementById('roadview');
  let map, rvObj;

  function buildMap(){
    if (!kakao?.maps) return; // SDK ì—†ìœ¼ë©´ ìŠ¤í‚µ(ìº¡ì²˜ë§Œ ê°€ëŠ¥)
    map = new kakao.maps.Map(mapEl, {
      center: new kakao.maps.LatLng((center?.lat||pos?.lat||37.5665), (center?.lng||pos?.lng||126.9780)),
      level: level ?? 3
    });
    if (type && map.setMapTypeId) { try{ map.setMapTypeId(type); }catch{} }
    (markers||[]).forEach(m=>{
      new kakao.maps.Marker({ position: new kakao.maps.LatLng(m.lat,m.lng), map, title: m.title||"" });
    });
  }

  function buildRoadview(){
    if (!kakao?.maps) return;
    rvEl.style.display='block';
    mapEl.style.display='none';
    const rvClient = new kakao.maps.RoadviewClient();
    rvObj = new kakao.maps.Roadview(rvEl);
    const latlng = new kakao.maps.LatLng((pos?.lat||center?.lat||37.5665), (pos?.lng||center?.lng||126.9780));
    rvClient.getNearestPanoId(latlng, 50, function(panoId){
      if(!panoId){
        rvEl.innerHTML = '<div style="color:#fff;display:flex;align-items:center;justify-content:center;height:100%">ë¡œë“œë·°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤</div>';
        return;
      }
      rvObj.setPanoId(panoId, latlng);
    });
  }

  if (rv) buildRoadview(); else buildMap();

  /* ---------------- ë¡œë”© ì™„ë£Œ ëŒ€ê¸° ---------------- */
  async function whenReady(){
    if (!kakao?.maps) { await new Promise(r=>setTimeout(r, 300)); return; }
    await new Promise(res=>{
      if (rv && rvObj){
        kakao.maps.event.addListener(rvObj, 'init', ()=> setTimeout(res, 350));
      } else if (map){
        kakao.maps.event.addListener(map, 'tilesloaded', ()=> setTimeout(res, 200));
      } else {
        setTimeout(res, 300);
      }
    });
  }
  await whenReady();

  /* ---------------- íŒŒì¼ëª… êµ¬ì„± ---------------- */
  function dateStr(){ const d=new Date(), y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,"0"), dd=String(d.getDate()).padStart(2,"0"); return `${y} ${m}${dd}`; }
  async function getAddrName(lat, lng){
    if (!kakao?.maps?.services?.Geocoder) return "";
    return new Promise(r=>{
      const g = new kakao.maps.services.Geocoder();
      g.coord2Address(lng, lat, (res, status)=>{
        if(status===kakao.maps.services.Status.OK && res[0]?.address){
          const a=res[0].address;
          r(a.region_3depth_name || a.region_2depth_name || "");
        } else r("");
      });
    });
  }
  const baseLat = pos?.lat || center?.lat || 37.5665;
  const baseLng = pos?.lng || center?.lng || 126.9780;
  let addrName = preAddrName || await getAddrName(baseLat, baseLng);
  window.__ADDR_NAME__ = addrName;

  /* ---------------- 1íšŒ ìº¡ì²˜ ---------------- */
  const ui  = document.getElementById('ui');
  const btn = document.getElementById('btnStart');

  btn.addEventListener('click', startCapture, { once:true });

  async function startCapture(){
    try{
      const stream = await navigator.mediaDevices.getDisplayMedia({
        video: { displaySurface: 'browser' }, audio: false
      });
      const track = stream.getVideoTracks()[0];

      ui.style.display='none';
      // ë ˆì´ì•„ì›ƒ/ì˜¤ë²„ë ˆì´ ì•ˆì •í™” ì•½ê°„ ëŒ€ê¸°
      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      await new Promise(r=>setTimeout(r, 250));

      const video = document.createElement('video');
      video.style.position='fixed'; video.style.top='-9999px';
      document.body.appendChild(video);
      video.srcObject = stream; await video.play();

      const scale = window.devicePixelRatio || 1;
      const w = Math.floor(window.innerWidth * scale);
      const h = Math.floor(window.innerHeight * scale);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);

      const prefix   = rv ? "roadview" : "map";
      const baseName = `${prefix}(${dateStr()}) ${addrName || "ì¢Œí‘œ"}`;

      await new Promise(res => canvas.toBlob(b=>{
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = `${baseName}.png`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
        res();
      }, 'image/png'));

      track.stop(); video.remove(); ui.style.display='';
      btn.textContent='âœ… ìº¡ì²˜ ì™„ë£Œ';
    }catch(e){
      console.error(e);
      ui.style.display=''; btn.textContent='ğŸš« ê¶Œí•œ ê±°ë¶€/ì˜¤ë¥˜ â€” ë‹¤ì‹œ ì‹œë„';
      btn.addEventListener('click', startCapture, { once:true });
    }
  }
})();
</script>
</body>
</html>
