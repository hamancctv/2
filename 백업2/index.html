
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>CCTV GIS</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />

<!-- Kakao Maps SDK (services + ìˆ˜ë™ ë¡œë“œ) -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=5f253bed8a8966a66fc9076b662663fd&libraries=services&autoload=false"></script>

<!-- ê¸°ì¡´ ìŠ¤íƒ€ì¼ - ìœ ì§€ -->
<link rel="stylesheet" href="style.css" />

<style>
  html, body { height:100%; margin:0; }
  #container { position:relative; height:100%; overflow:hidden; }
  #mapWrapper { position:relative; width:100%; height:100%; z-index:1; }
  #map { width:100%; height:100%; cursor: grab; }
  #map:active { cursor: grabbing; }

  .toolbar {
    position: fixed; top: 60px; left: 10px;
    display: flex; flex-direction: column; gap: 8px; z-index: 10;
  }
 .toolbar button {
  width: 42px; height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  line-height: 1;                /* âœ… ì´ ì¤„ì´ ì¤‘ìš”! (ì´ëª¨í‹°ì§€ ì„¸ë¡œ ì¤‘ì‹¬) */
  border: 1px solid #ccc;
  border-radius: 10px;
  background: linear-gradient(180deg, #fff 0%, #f8f8f8 100%);
  color: #333;
  cursor: pointer;
  transition: all .25s ease;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
  .toolbar button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.18);
    background: linear-gradient(180deg, #fff 0%, #f2f2f2 100%);
  }
  .toolbar button.active {
    border-color: #007aff;
    color: #007aff;
    background: linear-gradient(180deg, #eaf3ff 0%, #d7e9ff 100%);
    box-shadow: 0 0 0 3px rgba(0,122,255,0.15) inset, 0 3px 10px rgba(0,0,0,0.12);
    transform: translateY(1px);
  }
  /* === ìº¡ì²˜ ë²„íŠ¼ (ì´ì¤‘ ì› + ğŸ“· ì´ëª¨í‹°ì§€) === */
.capture-btn {
  position: relative;
  width: 42px; height: 42px;
  border-radius: 50%;
  border: 3px solid #fff;       /* í° í…Œë‘ë¦¬ */
  box-sizing: border-box;
  font-size: 22px;
    line-height: 1;     /* âœ… ì¤‘ì•™ ì •ë ¬ ë³´ì • */
  color: #fff;                  /* ğŸ“· ì´ëª¨í‹°ì§€ ìƒ‰ìƒ */
  display: flex;
  align-items: center;
  justify-content: center;
}

.capture-btn::after {
  content: "";
  position: absolute;
  top: -4px; left: -4px;
  width: calc(100% + 8px);
  height: calc(100% + 8px);
  border-radius: 50%;
  box-sizing: border-box;
  pointer-events: none;
}

.capture-btn:hover {
  transform: scale(1.06);
}
.capture-btn:active {
  transform: scale(0.94);
}

  /* ë¡œë“œë·° ì „ì²´í™”ë©´(ì§€ë„ëŠ” ë¯¸ë‹ˆë§µ) â€” DOMì€ ìœ ì§€(ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ìš©) */
  #rvWrapper { position:absolute; inset:0; display:none; z-index:0; }
  #roadview  { width:100%; height:100%; }
  .view_roadview #rvWrapper { display:block; z-index:1; }
  .view_roadview #mapWrapper {
    position:absolute; left:8px; bottom:8px;
    width:26%; height:26%; min-width:200px; min-height:150px;
    border:2px solid #ccc; border-radius:8px; background:#fff; z-index:2;
    box-shadow:0 8px 24px rgba(0,0,0,.2);
  }

  /* ë¯¸ë‹ˆë§µ ë¦¬ì‚¬ì´ì € í•¸ë“¤ â€” DOMì€ ìœ ì§€(ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ìš©) */
  #mapWrapper .rv-resizer {
    position: absolute;
    right: 0; top: 0;
    width: 20px; height: 20px;
    background: linear-gradient(225deg, #f4f4f4 0%, #f4f4f4 49.9%, transparent 50%);
    box-sizing: border-box; z-index: 9999;
    cursor: nesw-resize; pointer-events: auto;
    opacity: 0.75;
    transition: box-shadow 0.2s ease, background-color 0.2s ease;
    display:none; /* ë¡œë“œë·° ë¹„í™œì„± ê¸°ë³¸ê°’ */
  }
  .view_roadview #mapWrapper .rv-resizer{ display:block; }
  #mapWrapper .rv-resizer:hover {
    box-shadow: 0 0 8px rgba(0, 0, 0, 0.25);
    background: linear-gradient(225deg, #e9e9e9 0%, #e9e9e9 49.9%, transparent 50%);
  }

  /* === ê±°ë¦¬ì¬ê¸° UI === */
  .km-dot { width: 10px; height: 10px; border: 2px solid #e53935; background: #fff; border-radius: 50%; box-shadow: 0 0 0 1px rgba(0,0,0,.06); }
  .km-seg { background:#fff; color:#e53935; border:1px solid #e53935; border-radius:8px; padding:2px 6px; font-size:12px; font-weight:600; white-space:nowrap; box-shadow:0 2px 6px rgba(0,0,0,.12); margin-bottom:14px; }
  .km-total-box { background:#ffeb3b; color:#222; border:1px solid #e0c200; border-radius:10px; padding:6px 10px; font-size:13px; font-weight:700; box-shadow:0 2px 8px rgba(0,0,0,.15); pointer-events:none; white-space:nowrap; transform: translate(10px, 8px); }
</style>
</head>
<script>
const TOKEN_KEY = "mapAuthToken";
if (!localStorage.getItem(TOKEN_KEY)) {
  // âš ï¸ ì˜¤ë¹  ì›Œì»¤ ì£¼ì†Œë¡œ ë³€ê²½!
  location.href = "https://haman-auth.YOUR_SUBDOMAIN.workers.dev/login";
}
</script>


<body>
  <div id="container">
    <div id="mapWrapper">
      <div id="map"></div>

      <div class="toolbar">
        <button id="btnSatellite" class="btn-satellite" title="ìœ„ì„±ë·°">ğŸŒ</button>
        <button id="roadviewControl" title="ë¡œë“œë·°">ğŸš—</button>
        <button id="btnDistance" title="ê±°ë¦¬ì¬ê¸°">ğŸ“</button>
        <button id="btnGroupMST" title="ê·¸ë£¹ì—°ê²°">ğŸ§©</button>
        <button id="btnCapture" class="capture-btn" title="ì§€ë„ ìº¡ì²˜">ğŸ“·</button>

      </div>

      <!-- ë¦¬ì‚¬ì´ì € í•¸ë“¤(ë¡œë“œë·° ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì œì–´) -->
      <div class="rv-resizer" aria-hidden="true"></div>
    </div>

    <!-- ë¡œë“œë·° ì»¨í…Œì´ë„ˆ(ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì œì–´) -->
    <div id="rvWrapper"><div id="roadview"></div></div>
  </div>

  <script>
  // ì „ì—­: ë§ˆì»¤ í´ë¦­/í˜¸ë²„ í†µì œ í•¨ìˆ˜
  function setAllMarkersClickable(clickable) {
    const list = window.markers || [];
    for (const m of list) { try { m.setClickable(clickable); } catch(e){} }
    console.log(`[ë§ˆì»¤ ì¸í„°ë™ì…˜] ${clickable ? 'í™œì„±í™”' : 'ì°¨ë‹¨'}`);
  }
  </script>

  <!-- ì™¸ë¶€ ë°ì´í„°/í•¸ë“¤ëŸ¬ -->
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
  <script src="sel_suggest.js"></script> 
  <script src="markers-handler.js"></script>
  <script src="search-suggest.js"></script>
  <script src="drawGroupLinesMST.js"></script>
  <!-- <script src="btnDistance.js"></script> -->
  <!-- âœ… ë‚˜ì¤‘ì— ë¡œë“œë·° ë¶™ì¼ ë•Œ: <script src="roadview.js"></script> -->

  
<script>
/* ===== ê³µìš© í—¬í¼ ===== */
const $ = s => document.querySelector(s);

/* ===== ì „ì—­(ë¡œë“œë·° ìƒíƒœ/ê°ì²´ ì œê±°ë¨) ===== */
let map, geocoder, places;

/* ===== í† ìŠ¤íŠ¸ ===== */
function flash(msg) {
  const el = document.createElement('div');
  el.textContent = msg;
  el.style.cssText = 'position:fixed;left:50%;top:14px;transform:translateX(-50%);' +
    'background:rgba(0,0,0,.85);color:#fff;padding:8px 12px;border-radius:8px;' +
    'font-size:13px;z-index:9999;pointer-events:none';
  document.body.appendChild(el);
  setTimeout(()=>{ el.style.opacity='0'; el.style.transition='opacity .25s'; }, 1100);
  setTimeout(()=> el.remove(), 1500);
}
/* âœ… ë§ˆì»¤ í´ë¦­ ì „ì—­ ì œì–´ í•¨ìˆ˜ */
function setAllMarkersClickable(clickable) {
  const list = window.markers || [];
  for (const m of list) {
    try { m.setClickable(clickable); } catch(e){}
  }
  console.log(`[ë§ˆì»¤ í´ë¦­ ìƒíƒœ] ${clickable ? "í™œì„±í™”ë¨" : "ë¹„í™œì„±í™”ë¨"}`);
}

/* ===== ì´ˆê¸°í™” ===== */
kakao.maps.load(function(){
  const center = new kakao.maps.LatLng(35.2725308711779, 128.406307024695);
  map = new kakao.maps.Map(document.getElementById('map'), { center, level:4 });
    window.map = map;   // âœ… ë°˜ë“œì‹œ ì¶”ê°€ (btnCapture.jsì—ì„œ ì¸ì‹ ê°€ëŠ¥)

  map.setMaxLevel(9);
  geocoder = new kakao.maps.services.Geocoder();
  places   = new kakao.maps.services.Places();

    // âœ… ê±°ë¦¬ì¬ê¸° ì´ˆê¸°í™” (ì´ ì¤„ì´ ì—†ì–´ì„œ ì•ˆ ëë˜ ê±°ì˜ˆìš”!)
  if (window.DistanceModule?.setupDistance) {
    DistanceModule.setupDistance(map);
  }
    // âœ… ë¡œë“œë·° ì´ˆê¸°í™”ëŠ” ê·¸ëŒ€ë¡œ
  const rvDiv = document.getElementById("roadview");
  const rv = new kakao.maps.Roadview(rvDiv);
  const rvClient = new kakao.maps.RoadviewClient();
  window.__rvInstance = rv;       // âœ… ì¶”ê°€
  window.__mapInstance = map;     // âœ… ì¶”ê°€
  window.__rvClient = rvClient;   // âœ… ì¶”ê°€
  if (window.RoadviewModule?.initRoadview) {
    RoadviewModule.initRoadview(map, rv, rvClient);
  }

      // ìœ„ì„±ë·° í† ê¸€
  const btnSat = document.getElementById('btnSatellite');
  btnSat.addEventListener('click', ()=>{
    if(map.getMapTypeId() === kakao.maps.MapTypeId.ROADMAP){
      map.setMapTypeId(kakao.maps.MapTypeId.HYBRID); btnSat.classList.add('selected');
    } else {
      map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP); btnSat.classList.remove('selected');
    }
  });

  // ì™¸ë¶€ ë°ì´í„°ë¡œ ë§ˆì»¤ ìƒì„±
  if (window.SEL_SUGGEST && typeof initMarkers === 'function') {
    const unique = new Map(), positionsLike=[];
    for (const it of window.SEL_SUGGEST) {
      const lat = parseFloat(it.lat), lng = parseFloat(it.lng);
      if (!isFinite(lat) || !isFinite(lng)) continue;
      const key = lat+','+lng; if (unique.has(key)) continue; unique.set(key,true);
      positionsLike.push({
        latlng: new kakao.maps.LatLng(lat, lng),
        content: it.name1 || it.name || '',
        searchName: it.name2 || it.name || '',
        group: it.group || null,
        __lat: lat, __lng: lng
      });
    }
    initMarkers(map, positionsLike);
  }

  // ì œì•ˆì°½
  if (typeof initSuggestUI === 'function') {
    initSuggestUI({
      map, data: window.SEL_SUGGEST || [],
      parent: document.getElementById('mapWrapper'),
      getMarkers: () => window.markers,
      badges: ['line', 'enclosure', 'address', 'ip', 'group'],
      maxItems: 30, chooseOnEnter: true, openOnFocus: true
    });
  }

  // === ê·¸ë£¹ ì—°ê²° ë²„íŠ¼ í•¸ë“¤ëŸ¬ (ìœ ì§€) ===
  (function setupGroupMST() {
    const btn = document.getElementById('btnGroupMST');
    if (!btn) return;

    let mstActive = false;

    function ensureMarkerGroupCompatibility() {
      const arr = (window.markers || []).filter(Boolean);
      arr.forEach(mk => {
        const gx = mk.gx || {};
        mk.group = mk.group ?? gx.group ?? gx.grp ?? null;
        mk.name  = mk.name  ?? gx.content ?? gx.searchName ?? gx.name ?? '';
      });
      const dist = {};
      arr.forEach(mk => { const g = mk.group ?? '(ì—†ìŒ)'; dist[g] = (dist[g]||0)+1; });
      console.log('[MST:GROUP-DIST]', dist);
    }

    window.getMarkersByGroup = window.getMarkersByGroup || function() {
      const by = {};
      (window.markers || []).forEach(mk => {
        const g = (mk.group ?? mk.gx?.group ?? null);
        if (!g) return;
        (by[g] ||= []).push(mk);
      });
      return by;
    };

    btn.addEventListener('click', () => {
      mstActive = !mstActive;
      btn.classList.toggle('active', mstActive);

      if (mstActive) {
        // ê±°ë¦¬ì¬ê¸° ì¼œì ¸ ìˆìœ¼ë©´ ìë™ OFF
        const btnDist = document.getElementById('btnDistance');
        if (btnDist && btnDist.classList.contains('active')) btnDist.click();

        ensureMarkerGroupCompatibility();
        if (typeof drawMSTAllGroups === 'function') {
          drawMSTAllGroups(map);
          console.log('[MST] ê·¸ë£¹ì—°ê²° ì™„ë£Œ');
        } else {
          console.warn('[MST] drawGroupLinesMST.js ì—†ìŒ');
        }
      } else {
        if (typeof clearMSTLines === 'function') clearMSTLines();
        console.log('[MST] ê·¸ë£¹ì—°ê²° í•´ì œ');
      }
    });
  })(); // setupGroupMST ë

}); // kakao.maps.load ë
</script>
<!-- ğŸ”¹ ë¡œë“œë·° ëª¨ë“ˆ ë¨¼ì € -->
 <script src="btnDistance.js"></script> <!-- âœ… ì¶”ê°€ -->
 <script src="roadview.js"></script>
 <!-- âœ… ì§€ë„ ìº¡ì²˜ ê¸°ëŠ¥ (ë³„ë„ ëª¨ë“ˆ) -->
<script src="btnCapture.js"></script>
</body>
</html>
